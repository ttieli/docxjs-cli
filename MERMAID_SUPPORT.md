# DocxJS è½¬æ¢å™¨ Mermaid ç¦»çº¿æ”¯æŒè®¾è®¡æ–¹æ¡ˆ

## ğŸš« å½“å‰ç—›ç‚¹ä¸éœ€æ±‚
ç›®å‰çš„ Mermaid æ”¯æŒä¾èµ–å¤–éƒ¨æœåŠ¡ï¼ˆmermaid.ink / Krokiï¼‰æˆ– CDN åŠ è½½ JS åº“ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1.  **ä¾èµ–å…¬ç½‘**ï¼šåœ¨æ— ç½‘æˆ–å†…ç½‘ç¯å¢ƒæ— æ³•ä½¿ç”¨ã€‚
2.  **éšç§é£é™©**ï¼šä¸šåŠ¡æ•°æ®ï¼ˆæµç¨‹å›¾å†…å®¹ï¼‰ä¼šè¢«å‘é€åˆ°ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ã€‚
3.  **ç¨³å®šæ€§**ï¼šå—é™äºå¤–éƒ¨æœåŠ¡ç¨³å®šæ€§å’Œ URL é•¿åº¦é™åˆ¶ã€‚

**ç›®æ ‡**ï¼šå®ç°ä¸€ä¸ª**å®Œå…¨ç¦»çº¿ã€é›¶å¤–éƒ¨ä¾èµ–**çš„ Mermaid æ¸²æŸ“æ–¹æ¡ˆã€‚

---

## ğŸ›  ç¦»çº¿æ¸²æŸ“æ¶æ„è®¾è®¡ (Offline Architecture)

æˆ‘ä»¬å°†ç§»é™¤æ‰€æœ‰åœ¨çº¿ API è°ƒç”¨ï¼Œè½¬è€Œä½¿ç”¨é¡¹ç›®å†…ç½®çš„ Mermaid æ ¸å¿ƒåº“é…åˆæœ¬åœ° Playwright å¼•æ“è¿›è¡Œæ¸²æŸ“ã€‚

### 1. æ ¸å¿ƒæµç¨‹æ”¹é€ 

**åŸæµç¨‹**ï¼š
MD è§£æ -> å°è¯• mermaid.ink (åœ¨çº¿) -> å¤±è´¥ -> å°è¯• Kroki (åœ¨çº¿) -> å¤±è´¥ -> Playwright åŠ è½½ CDN JS (åœ¨çº¿) -> æˆªå›¾

**æ–°æµç¨‹ (çº¯ç¦»çº¿)**ï¼š
MD è§£æ -> **Playwright åŠ è½½æœ¬åœ° Mermaid åº“** -> æµè§ˆå™¨å†…æ¸²æŸ“ -> æˆªå›¾ -> åµŒå…¥ Word

### 2. å…³é”®å®ç°æ­¥éª¤

#### ç¬¬ä¸€æ­¥ï¼šæœ¬åœ°åŒ– Mermaid åº“
ä¸å†é€šè¿‡ CDN åŠ è½½ `mermaid.min.js`ï¼Œè€Œæ˜¯å°†å…¶ä½œä¸ºé™æ€èµ„æºæ‰“åŒ…åœ¨é¡¹ç›®ä¸­ã€‚
*   **æ“ä½œ**ï¼šä¸‹è½½ `mermaid.min.js` (v10.x) åˆ° `public/vendor/mermaid/` æˆ– `lib/vendor/` ç›®å½•ã€‚
*   **ä¼˜åŠ¿**ï¼šç¡®ä¿è¿è¡Œæ—¶æ— éœ€ä»»ä½•ç½‘ç»œè¯·æ±‚ã€‚

#### ç¬¬äºŒæ­¥ï¼šæ”¹é€  `renderMermaidLocally` å‡½æ•°
ä¿®æ”¹ `lib/core.js` ä¸­çš„æ¸²æŸ“é€»è¾‘ï¼š
1.  **è¯»å–æœ¬åœ°æ–‡ä»¶**ï¼šä½¿ç”¨ `fs.readFileSync` è¯»å–æœ¬åœ°çš„ `mermaid.min.js` å†…å®¹ã€‚
2.  **æ³¨å…¥æµè§ˆå™¨**ï¼šåœ¨ Playwright åˆ›å»ºé¡µé¢æ—¶ï¼Œå°†è¯»å–åˆ°çš„ JS å†…å®¹ç›´æ¥æ³¨å…¥ `<script>` æ ‡ç­¾ã€‚
3.  **æ‰§è¡Œæ¸²æŸ“**ï¼šè°ƒç”¨ `mermaid.initialize()` å’Œ `mermaid.render()` (æˆ–è®©å…¶è‡ªåŠ¨æ¸²æŸ“)ã€‚
4.  **æˆªå›¾**ï¼šè·å– SVG å…ƒç´ å¹¶æˆªå›¾è¿”å› Bufferã€‚

#### ç¬¬ä¸‰æ­¥ï¼šæ¸…ç†å¤–éƒ¨ä¾èµ–
*   åˆ é™¤ `mermaid.ink` å’Œ `kroki.io` çš„ç›¸å…³ä»£ç ã€‚
*   ç§»é™¤æ‰€æœ‰æ¶‰åŠ `axios` è¯·æ±‚å¤–éƒ¨å›¾ç‰‡æœåŠ¡çš„é€»è¾‘ã€‚

---

## ğŸ’» ä»£ç å®ç°æ€è·¯ (ä¼ªä»£ç )

```javascript
// lib/core.js

// 1. å¼•å…¥æœ¬åœ° Mermaid åº“è·¯å¾„
const MERMAID_LIB_PATH = path.join(__dirname, '../public/vendor/mermaid/mermaid.min.js');

async function renderMermaidLocally(mermaidCode) {
    // ... å¯åŠ¨ Playwright ...

    // 2. è¯»å–æœ¬åœ° JS
    const mermaidJsContent = fs.readFileSync(MERMAID_LIB_PATH, 'utf-8');

    // 3. æ„å»ºå®Œå…¨ç¦»çº¿çš„ HTML
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <style>body { margin: 0; background: white; }</style>
        <!-- ç›´æ¥æ³¨å…¥ JS ä»£ç ï¼Œä¸ä½¿ç”¨ src URL -->
        <script>${mermaidJsContent}</script>
    </head>
    <body>
        <div id="container" class="mermaid">${mermaidCode}</div>
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    </body>
    </html>`;

    // ... è®¾ç½®é¡µé¢å†…å®¹å¹¶ç­‰å¾…é€‰æ‹©å™¨ ...
    // ... æˆªå›¾å¹¶å…³é—­æµè§ˆå™¨ ...
}
```

## âœ… æ–¹æ¡ˆä¼˜åŠ¿

1.  **100% ç¦»çº¿å¯ç”¨**ï¼šé€‚ç”¨äºé“¶è¡Œã€æ”¿ä¼ç­‰å†…ç½‘ç¯å¢ƒã€‚
2.  **æ•°æ®å®‰å…¨**ï¼šå›¾è¡¨æ•°æ®ä¸å‡ºæœ¬åœ°æœºå™¨ã€‚
3.  **æè‡´ç¨³å®š**ï¼šä¸å—ç½‘ç»œæ³¢åŠ¨æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡å®•æœºå½±å“ã€‚
4.  **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰å¹³å°ï¼ˆCLI/Web/Appï¼‰ä½¿ç”¨åŒä¸€å¥—æ¸²æŸ“å†…æ ¸ï¼Œæ•ˆæœå®Œå…¨ä¸€è‡´ã€‚
