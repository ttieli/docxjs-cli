<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>docxjs-cli Web</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
    
    :root {
      /* Color System */
      --primary: #4A78A6;       /* è“ç°è‰² - ä¸»è‰² */
      --primary-hover: #3A66A1;
      --bg-page: #FAFAFA;       /* é¡µé¢èƒŒæ™¯ */
      --bg-panel: #FFFFFF;      /* å®¹å™¨èƒŒæ™¯ */
      --bg-input: #F7F9FC;      /* è¾“å…¥æ¡†èƒŒæ™¯ */
      --bg-subtle: #E8F0FA;     /* è¾…è‰²èƒŒæ™¯ */
      
      --text-main: #333333;     /* æ­£æ–‡ */
      --text-sub: #666666;      /* æ¬¡è¦ä¿¡æ¯ */
      --text-placeholder: #999999;
      
      --border: #DDDDDD;        /* è¾¹æ¡†çº¿ */
      --border-focus: #4A78A6;  
      
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --radius: 6px;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background-color: var(--bg-page);
      color: var(--text-main);
      line-height: 1.5;
    }

    header {
      padding: 32px 24px 24px;
      max-width: 1100px;
      margin: 0 auto;
      border-bottom: 1px solid transparent; /* Placeholder */
    }

    h1 { 
      margin: 0 0 8px; 
      font-size: 24px; 
      font-weight: 600; 
      color: var(--primary);
      letter-spacing: -0.01em;
    }
    
    p.lead { margin: 0; color: var(--text-sub); font-size: 14px; }

    main {
      max-width: 1200px;
      margin: 0 auto 48px;
      padding: 0 24px 32px;
    }

    /* Layout */
    .columns {
      display: grid;
      gap: 24px;
      grid-template-columns: 1.2fr 0.8fr 1fr;
      align-items: start;
    }

    /* Panels */
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }

    /* Form Elements */
    label {
      display: block;
      font-size: 14px;
      color: var(--text-sub);
      margin-bottom: 8px;
      font-weight: 500;
    }

    textarea, select, input[type="text"], input[type="number"], input[type="file"] {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-main);
      border-radius: var(--radius);
      padding: 0 12px;
      height: 38px; /* Standard height */
      line-height: 36px;
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    textarea { 
      min-height: 320px; 
      resize: vertical; 
      line-height: 1.6; 
      padding: 12px; 
      height: auto;
    }

    textarea:focus, select:focus, input:focus {
      border-color: var(--border-focus);
      background: #FFFFFF;
      box-shadow: 0 0 0 3px rgba(74, 120, 166, 0.1);
    }

    /* Buttons */
    button {
      background: var(--primary);
      color: #FFFFFF;
      border: none;
      border-radius: var(--radius);
      padding: 0 20px;
      height: 40px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s ease;
    }

    button:hover:not(:disabled) { background: var(--primary-hover); }
    button:disabled { opacity: 0.6; cursor: not-allowed; background: var(--text-placeholder); }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-sub);
      padding: 0 16px;
      height: 32px;
      font-size: 13px;
      border-radius: 99px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      width: auto;
    }
    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--bg-subtle);
    }

    /* Status & Pills */
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 99px;
      background: var(--bg-subtle);
      color: var(--primary);
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .status { margin-top: 12px; font-size: 13px; min-height: 20px; }
    .status.success { color: #2E7D32; } /* Green */
    .status.error { color: #D32F2F; }   /* Red */
    .status.info { color: var(--primary); }

    .hint { color: var(--text-placeholder); font-size: 12px; margin-top: 6px; line-height: 1.4; }

    /* File Import Button */
    .import-btn {
      cursor: pointer; 
      font-size: 12px; 
      color: var(--primary); 
      border: 1px solid var(--border); 
      padding: 4px 10px; 
      border-radius: var(--radius); 
      background: #FFFFFF;
      transition: all 0.2s;
    }
    .import-btn:hover {
      border-color: var(--primary);
      background: var(--bg-subtle);
    }

    /* Usage List */
    .list {
      display: grid;
      gap: 8px;
    }
    .list-item {
      padding: 8px 12px;
      border-radius: var(--radius);
      background: var(--bg-input);
      border: 1px solid transparent;
      font-size: 13px;
      color: var(--text-sub);
    }
    .list-item b { color: var(--text-main); }

    .suffix {
      padding: 0 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-left: none;
      border-radius: 0 var(--radius) var(--radius) 0;
      color: var(--text-sub);
      font-size: 13px;
      display: flex;
      align-items: center;
      height: 38px;
    }
    #fileName { border-radius: var(--radius) 0 0 var(--radius); }

    /* Style Editor (Accordion) */
    details.style-group {
      background: #FFFFFF;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 8px;
      overflow: hidden;
    }
    details.style-group summary {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-main);
      font-weight: 500;
      background: var(--bg-page); /* Slightly darker than panel */
      border-bottom: 1px solid transparent;
      transition: all 0.2s;
      display: flex; justify-content: space-between; align-items: center;
    }
    details.style-group[open] summary {
      border-bottom-color: var(--border);
      color: var(--primary);
    }
    details.style-group summary:hover { background: var(--bg-subtle); }
    details.style-group summary::after { content: '+'; font-weight: 600; color: var(--text-placeholder); }
    details.style-group[open] summary::after { content: 'âˆ’'; color: var(--primary); }
    
    .style-grid {
      padding: 16px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      align-items: end;
    }
    .style-grid > div { display: flex; flex-direction: column; gap: 4px; }
    .style-grid label { font-size: 12px; margin: 0; color: var(--text-placeholder); }

    /* Specific Inputs */
    input[type="color"] {
      padding: 2px;
      background: #FFFFFF;
      cursor: pointer;
      height: 38px;
    }
    .checkbox-wrapper {
      height: 38px;
      display: flex;
      align-items: center;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0 12px;
    }
    
    .toggle-row {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
    }
    .toggle-btn {
      background: transparent; border: 1px solid var(--border); color: var(--text-sub);
      width: auto; height: 28px; padding: 0 12px; font-size: 12px;
    }
    .toggle-btn:hover { border-color: var(--primary); color: var(--primary); }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4); /* Darker dim */
      backdrop-filter: blur(2px);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; transition: opacity 0.2s ease;
    }
    .modal-overlay.open { display: flex; opacity: 1; }
    .modal-content {
      background: #FFFFFF;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      width: 90%; max-width: 640px; max-height: 85vh;
      display: flex; flex-direction: column;
      transform: scale(0.98); transition: transform 0.2s;
    }
    .modal-overlay.open .modal-content { transform: scale(1); }
    .modal-header {
      padding: 16px 24px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h3 { margin: 0; font-size: 18px; color: var(--text-main); }
    .close-btn { color: var(--text-placeholder); width: auto; font-size: 24px; padding: 0; height: auto; background: none; }
    .close-btn:hover { color: var(--text-main); }
    
    .tabs {
      padding: 4px 24px; margin-top: 16px;
      border-bottom: 1px solid var(--border);
      display: flex; gap: 24px;
    }
    .tab-btn {
      background: none; border: none; border-bottom: 2px solid transparent;
      padding: 8px 0; font-size: 14px; color: var(--text-sub);
      border-radius: 0; width: auto; height: auto;
    }
    .tab-btn.active {
      color: var(--primary); border-bottom-color: var(--primary); font-weight: 600;
    }
    .modal-body { padding: 24px; overflow-y: auto; }
    .guide-block h4 { color: var(--primary); margin: 20px 0 10px; font-size: 15px; }
    .guide-block p { color: var(--text-sub); margin-bottom: 12px; }
    .guide-block code {
      background: var(--bg-subtle); color: var(--primary); 
      padding: 2px 6px; border-radius: 4px; font-family: monospace;
    }
    .guide-block pre {
      background: var(--bg-input); border: 1px solid var(--border);
      padding: 12px; border-radius: var(--radius); overflow-x: auto;
    }

    @media (max-width: 960px) { .columns { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; justify-content:space-between; align-items:start;">
      <div>
        <div class="pill">docxjs-cli Â· Web é¢æ¿</div>
        <h1>Markdown è½¬ Docx Â· åœ¨çº¿è°ƒç”¨</h1>
        <p class="lead">é€‰æ‹©æ¨¡æ¿ã€å¡«å†™ Markdownï¼Œå¯é€‰ä¸Šä¼ å‚è€ƒ Wordï¼Œç‚¹å‡»ä¸€é”®è½¬æ¢å³å¯ä¸‹è½½ Docxã€‚</p>
      </div>
      <button class="btn-outline" id="openGuideBtn">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4M12 8h.01"></path></svg>
        ä½¿ç”¨æŒ‡å—
      </button>
    </div>
  </header>

  <main>
    <section class="columns">
      <div class="panel">
        <label style="font-weight:700;">è¾“å…¥</label>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <label for="markdownInput" style="margin:0; color:var(--muted); font-size:14px;">Markdown å†…å®¹</label>
          <label for="importMd" style="cursor:pointer; font-size:12px; color:var(--accent-2); border:1px solid var(--border); padding:4px 10px; border-radius:6px; transition: all 0.2s;">
            ğŸ“‚ å¯¼å…¥æ–‡ä»¶ (Md/Word)
            <input id="importMd" type="file" accept=".md,.txt,.docx" style="display:none;">
          </label>
        </div>
        <textarea id="markdownInput" spellcheck="false"># ç¤ºä¾‹æ ‡é¢˜

è¿™æ˜¯ä¸€æ®µç¤ºä¾‹æ–‡æœ¬ï¼ŒåŒ…å« **ç²—ä½“**ã€*æ–œä½“*ã€`ä»£ç ` å’Œè¡¨æ ¼ï¼š

| åˆ—1 | åˆ—2 |
| --- | --- |
| A1 | B1 |
| A2 | B2 |</textarea>
      </div>

      <div class="panel">
        <label style="font-weight:700;">è¾“å‡º</label>
        <div style="margin-top:6px;">
          <label style="margin-top:14px;" for="fileName">è¾“å‡ºæ–‡ä»¶å</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="fileName" type="text" placeholder="output" style="flex:1;" />
            <div class="suffix">.docx</div>
          </div>
          <div class="hint">ä»…ä¿®æ”¹å‰ç¼€ï¼Œåç¼€å›ºå®šä¸º .docxï¼ˆä»…å­—æ¯/æ•°å­—/._- ä¿ç•™ï¼‰ã€‚</div>

          <label style="margin-top:14px;">å‚è€ƒ Wordï¼ˆå¯é€‰ï¼Œæœ€å¤§ 5MBï¼‰</label>
          <input id="referenceDoc" type="file" accept=".docx" />
          <div class="hint">ä¸Šä¼ åè‡ªåŠ¨æå–å­—ä½“/é¡µè¾¹è·/è¡¨æ ¼æ ·å¼ã€‚</div>
        </div>
        <div style="margin-top:20px;">
          <button id="convertBtn">è½¬æ¢å¹¶ä¸‹è½½</button>
          <div id="status" class="status"></div>
        </div>
      </div>

      <div class="panel" style="background: rgba(255,255,255,0.02); border: 1px dashed var(--border);">
        <label style="font-weight:700;">æ¨¡æ¿</label>
        <label for="templateSelect" style="margin-top:6px;">æ¨¡æ¿ (æ¥è‡ª /api/templates)</label>
        <select id="templateSelect">
          <option value="">åŠ è½½ä¸­...</option>
        </select>
        <div class="hint">åˆ‡æ¢æ¨¡æ¿ä¼šè‡ªåŠ¨åˆ·æ–°ä¸‹æ–¹å¯ç¼–è¾‘æ ·å¼ï¼Œä»…å½±å“æœ¬æ¬¡è½¬æ¢ã€‚</div>

        <div style="margin-top:14px;">
          <div class="toggle-row">
            <label style="margin-bottom:10px;">æ¨¡æ¿æ ·å¼ï¼ˆå¯ç¼–è¾‘ï¼Œä»…å½±å“æœ¬æ¬¡è½¬æ¢ï¼‰</label>
            <button type="button" class="toggle-btn" id="toggleStyleBtn">æ”¶èµ·</button>
          </div>
          <div id="styleEditor">
            
            <details class="style-group">
              <summary>ä¸€çº§æ ‡é¢˜ (H1)</summary>
              <div class="style-grid">
                <div>
                  <label>å­—ä½“</label>
                  <input id="fontHeader1" type="text" placeholder="å¦‚ æ–¹æ­£å°æ ‡å®‹ç®€ä½“" />
                </div>
                <div>
                  <label>å­—å· (half-pt)</label>
                  <input id="fontSizeH1" type="number" min="8" max="120" />
                </div>
                <div>
                  <label>é¢œè‰²</label>
                  <input id="colorHeader1" type="color" />
                </div>
              </div>
            </details>

            <details class="style-group">
              <summary>äºŒçº§æ ‡é¢˜ (H2)</summary>
              <div class="style-grid">
                <div>
                  <label>å­—ä½“</label>
                  <input id="fontHeader2" type="text" placeholder="å¦‚ é»‘ä½“" />
                </div>
                <div>
                  <label>å­—å· (half-pt)</label>
                  <input id="fontSizeH2" type="number" min="8" max="120" />
                </div>
                <div>
                  <label>é¢œè‰²</label>
                  <input id="colorHeader2" type="color" />
                </div>
              </div>
            </details>

            <details class="style-group">
              <summary>ä¸‰çº§æ ‡é¢˜ (H3)</summary>
              <div class="style-grid">
                <div>
                  <label>å­—ä½“</label>
                  <input id="fontHeader3" type="text" placeholder="å¦‚ ä»¿å®‹_GB2312" />
                </div>
                <div>
                  <label>å­—å· (half-pt)</label>
                  <input id="fontSizeH3" type="number" min="8" max="120" />
                </div>
                <div>
                  <label>é¢œè‰²</label>
                  <input id="colorHeader3" type="color" />
                </div>
              </div>
            </details>

            <details class="style-group">
              <summary>æ­£æ–‡ (Body)</summary>
              <div class="style-grid">
                <div>
                  <label>å­—ä½“</label>
                  <input id="fontMain" type="text" placeholder="å¦‚ ä»¿å®‹_GB2312" />
                </div>
                <div>
                  <label>å­—å· (half-pt)</label>
                  <input id="fontSizeMain" type="number" min="8" max="120" />
                </div>
                <div>
                  <label>é¢œè‰²</label>
                  <input id="colorMain" type="color" />
                </div>
                <div>
                  <label>è¡Œè· (twips)</label>
                  <input id="lineSpacing" type="number" min="0" />
                </div>
              </div>
            </details>

            <details class="style-group">
              <summary>é¡µè¾¹è· (Margins)</summary>
              <div class="style-grid">
                <div>
                  <label>ä¸Š (twips/cm)</label>
                  <input id="marginTop" type="text" />
                </div>
                <div>
                  <label>ä¸‹ (twips/cm)</label>
                  <input id="marginBottom" type="text" />
                </div>
                <div>
                  <label>å·¦ (twips/cm)</label>
                  <input id="marginLeft" type="text" />
                </div>
                <div>
                  <label>å³ (twips/cm)</label>
                  <input id="marginRight" type="text" />
                </div>
              </div>
            </details>

            <details class="style-group">
              <summary>è¡¨æ ¼æ ·å¼ (Table)</summary>
              <div class="style-grid">
                <div>
                  <label>è¾¹æ¡†æ ·å¼</label>
                  <select id="tableBorderStyle">
                    <option value="">(é»˜è®¤)</option>
                    <option value="single">å•å®çº¿</option>
                    <option value="dotted">ç‚¹çº¿</option>
                    <option value="dashed">è™šçº¿</option>
                    <option value="double">åŒçº¿</option>
                    <option value="none">æ— è¾¹æ¡†</option>
                  </select>
                </div>
                <div>
                  <label>è¾¹æ¡†é¢œè‰²</label>
                  <input id="tableBorderColor" type="color" />
                </div>
                <div>
                  <label>è¾¹æ¡†ç²—ç»†</label>
                  <input id="tableBorderSize" type="number" min="1" max="16" />
                </div>
                <div>
                  <label>è¡¨å¤´åŠ ç²—</label>
                  <div class="checkbox-wrapper">
                    <input id="tableHeaderBold" type="checkbox" />
                  </div>
                </div>
                <div>
                  <label>è¡¨å¤´é¢œè‰²</label>
                  <input id="tableHeaderColor" type="color" />
                </div>
                <div>
                  <label>å•å…ƒæ ¼å¯¹é½</label>
                  <select id="tableCellAlign">
                    <option value="">(é»˜è®¤)</option>
                    <option value="left">å·¦</option>
                    <option value="center">å±…ä¸­</option>
                    <option value="right">å³</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="hint" style="margin-top:8px;">ä¿®æ”¹åç›´æ¥ç”Ÿæ•ˆï¼Œæäº¤æ—¶ä¼šéšè¯·æ±‚å‘é€ï¼ˆä»…å½±å“æœ¬æ¬¡è½¬æ¢ï¼Œä¸å†™å›æ¨¡æ¿æ–‡ä»¶ï¼‰ã€‚</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-overlay" id="guideModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ä½¿ç”¨æŒ‡å—</h3>
        <button class="close-btn" id="closeGuideBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <button class="tab-btn active" data-tab="web">Web ç‰ˆæŒ‡å—</button>
          <button class="tab-btn" data-tab="cli">å‘½ä»¤è¡Œç‰ˆæŒ‡å—</button>
        </div>
        
        <div id="web" class="tab-content active guide-block">
          <p>é€šè¿‡æœ¬ç•Œé¢ï¼Œæ‚¨å¯ä»¥ç›´æ¥è°ƒç”¨åå° API è¿›è¡Œæ–‡æ¡£è½¬æ¢ã€‚</p>
          <div class="list" style="grid-template-columns: 1fr;">
            <div class="list-item">1. <b>è¾“å…¥å†…å®¹</b>ï¼šåœ¨å·¦ä¾§æ–‡æœ¬æ¡†å¡«å†™ Markdown å†…å®¹ï¼Œæˆ–ç›´æ¥ç²˜è´´ã€‚æ”¯æŒå¯¼å…¥ .md/.txt æ–‡ä»¶ã€‚</div>
            <div class="list-item">2. <b>é€‰æ‹©æ¨¡æ¿</b>ï¼šåœ¨å³ä¾§é€‰æ‹©åˆé€‚çš„æ¨¡æ¿ï¼ˆå¦‚â€œä¸­å›½æ”¿åºœå…¬æ–‡â€ï¼‰ã€‚</div>
            <div class="list-item">3. <b>å¾®è°ƒæ ·å¼</b>ï¼ˆå¯é€‰ï¼‰ï¼šå±•å¼€â€œæ¨¡æ¿æ ·å¼â€åŒºåŸŸï¼ŒæŒ‰éœ€ä¿®æ”¹å„çº§æ ‡é¢˜ã€æ­£æ–‡ã€è¡¨æ ¼ç­‰æ ·å¼ã€‚</div>
            <div class="list-item">4. <b>å‚è€ƒæ–‡æ¡£</b>ï¼ˆå¯é€‰ï¼‰ï¼šä¸Šä¼ ä¸€ä¸ªç°æœ‰çš„ Docx æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æå–å…¶é¡µè¾¹è·å’Œå­—ä½“æ ·å¼åº”ç”¨åˆ°å½“å‰è½¬æ¢ä¸­ã€‚</div>
            <div class="list-item">5. <b>ç”Ÿæˆ</b>ï¼šç‚¹å‡»â€œè½¬æ¢å¹¶ä¸‹è½½â€ï¼Œç¨ç­‰ç‰‡åˆ»å³å¯è·å– .docx æ–‡ä»¶ã€‚</div>
          </div>
        </div>

        <div id="cli" class="tab-content guide-block">
          <p>æ‚¨ä¹Ÿå¯ä»¥åœ¨æœåŠ¡å™¨ç»ˆç«¯ä½¿ç”¨ <code>docxjs</code> å‘½ä»¤ã€‚</p>
          
          <h4>1. äº¤äº’å¼æ¨¡å¼ (æ¨è)</h4>
          <p>ä¸å¸¦å‚æ•°è¿è¡Œï¼Œé€šè¿‡é”®ç›˜èœå•é€‰æ‹©æ¨¡æ¿ï¼š</p>
          <pre><code>docxjs input.md -o output.docx</code></pre>

          <h4>2. æŒ‡å®šæ¨¡æ¿ (å…¬æ–‡çº¢å¤´)</h4>
          <pre><code>docxjs input.md -o output.docx -t gov_official_red</code></pre>

          <h4>3. æ··åˆæ¨¡å¼ (æ¨¡æ¿ + æ ·å¼å¸å–)</h4>
          <p>ä½¿ç”¨çº¢å¤´æ¨¡æ¿ç»“æ„ï¼Œä½†ä»çœŸå®æ–‡æ¡£æå–å­—ä½“/è¾¹è·ï¼š</p>
          <pre><code>docxjs input.md -o output.docx -t gov_official_red -r ref.docx</code></pre>
          
          <h4>4. è‡ªå®šä¹‰é…ç½®</h4>
          <pre><code>docxjs input.md -o out.docx --config styles.json</code></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- API Adapter -->
  <script src="api-adapter.js"></script>
  <script>
    const templateSelect = document.getElementById('templateSelect');
    const statusEl = document.getElementById('status');
    const convertBtn = document.getElementById('convertBtn');
    const markdownInput = document.getElementById('markdownInput');
    const importMdInput = document.getElementById('importMd');
    const referenceInput = document.getElementById('referenceDoc');
    const fileNameInput = document.getElementById('fileName');
    const DEFAULT_BASE_NAME = 'output';
    fileNameInput.value = DEFAULT_BASE_NAME;
    let templatesCache = {};
    let styleExpanded = true;

    function setStatus(text, type = '') {
      statusEl.textContent = text || '';
      statusEl.className = `status ${type}`;
    }
    
    // Import File (Markdown or Docx)
    importMdInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // If it's a Word document
      if (file.name.toLowerCase().endsWith('.docx')) {
        setStatus('æ­£åœ¨è§£æ Word æ–‡æ¡£...', 'info');

        try {
          // 1. Get Markdown Content from Backend via API Adapter
          const data = await API.importDocx(file);
          
          markdownInput.value = data.markdown || '';
          setStatus('Word å¯¼å…¥æˆåŠŸï¼å·²è½¬æ¢ä¸º Markdownã€‚', 'success');

          // 2. Auto-set as Reference Doc for Style Extraction
          const dt = new DataTransfer();
          dt.items.add(file);
          referenceInput.files = dt.files;
          
          // Auto-suggest filename
          const baseName = file.name.replace(/\.[^/.]+$/, "");
          fileNameInput.value = baseName + "_converted";

        } catch (err) {
          setStatus(`å¯¼å…¥å¤±è´¥: ${err.message}`, 'error');
        }
      } 
      // If it's a text/markdown file
      else {
        const reader = new FileReader();
        reader.onload = (evt) => {
          markdownInput.value = evt.target.result;
          setStatus('Markdown å¯¼å…¥æˆåŠŸ', 'success');
        };
        reader.onerror = () => {
          setStatus('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
        };
        reader.readAsText(file);
      }
      
      // Reset input allows re-selecting same file
      importMdInput.value = ''; 
    });

    // Guide Modal Logic
    const modal = document.getElementById('guideModal');
    const openBtn = document.getElementById('openGuideBtn');
    const closeBtn = document.getElementById('closeGuideBtn');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    function toggleModal(show) {
      if (show) {
        modal.style.display = 'flex';
        // force reflow
        modal.offsetHeight;
        modal.classList.add('open');
      } else {
        modal.classList.remove('open');
        setTimeout(() => {
          if (!modal.classList.contains('open')) modal.style.display = 'none';
        }, 200);
      }
    }

    openBtn.addEventListener('click', () => toggleModal(true));
    closeBtn.addEventListener('click', () => toggleModal(false));
    modal.addEventListener('click', (e) => {
      if (e.target === modal) toggleModal(false);
    });

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
        // Hide other tabs
        tabContents.forEach(content => {
           if (content.id !== btn.dataset.tab) content.classList.remove('active');
        });
      });
    });

    async function loadTemplates() {
      try {
        // Use API Adapter
        const data = await API.getTemplates();

        templatesCache = {};
        templateSelect.innerHTML = '';
        data.forEach(item => { templatesCache[item.id] = item.style || {}; });

        data.forEach((item, idx) => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = `${item.id} - ${item.description || 'No desc'}`;
          if (item.id === 'default') opt.selected = true;
          templateSelect.appendChild(opt);
        });
        // Populate style form with default template
        const initialTemplate = templateSelect.value || (data[0] && data[0].id);
        applyTemplateStyle(initialTemplate);
      } catch (err) {
        setStatus(`æ¨¡æ¿åŠ è½½å¤±è´¥ï¼š${err.message}`, 'error');
        templateSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
      }
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename || 'output.docx';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    async function handleSubmit() {
      const markdown = markdownInput.value.trim();
      if (!markdown) {
        setStatus('è¯·è¾“å…¥ Markdown å†…å®¹', 'error');
        return;
      }
      const templateName = templateSelect.value;
      const referenceDoc = referenceInput.files[0];
      if (referenceDoc && referenceDoc.size > 5 * 1024 * 1024) {
        setStatus('å‚è€ƒæ–‡ä»¶è¶…è¿‡ 5MB é™åˆ¶', 'error');
        return;
      }
      const rawBase = fileNameInput.value.trim();
      const safeBase = rawBase.replace(/[^a-zA-Z0-9._-]/g, '_');
      const finalName = (safeBase || DEFAULT_BASE_NAME) + '.docx';
      const styleConfig = buildStyleConfig();

      convertBtn.disabled = true;
      setStatus('è½¬æ¢ä¸­ï¼Œè¯·ç¨å€™...', '');
      try {
        // Use API Adapter
        const blob = await API.convert({
            markdown,
            templateName,
            filename: finalName,
            referenceDoc,
            styleConfig
        });
        
        downloadBlob(blob, finalName);
        setStatus('è½¬æ¢å®Œæˆï¼Œå·²è§¦å‘ä¸‹è½½ã€‚', 'success');
      } catch (err) {
        setStatus(err.message || 'è½¬æ¢å¤±è´¥', 'error');
      } finally {
        convertBtn.disabled = false;
      }
    }

    function toggleStyleEditor() {
      styleExpanded = !styleExpanded;
      const editor = document.getElementById('styleEditor');
      const btn = document.getElementById('toggleStyleBtn');
      editor.style.display = styleExpanded ? 'block' : 'none';
      btn.textContent = styleExpanded ? 'æ”¶èµ·' : 'å±•å¼€';
    }

    convertBtn.addEventListener('click', (e) => {
      e.preventDefault();
      handleSubmit();
    });

    function hexToInput(hex) {
      if (!hex || typeof hex !== 'string') return '#000000';
      let clean = hex.replace('#', '');
      if (clean.length === 3) clean = clean.split('').map(c => c + c).join('');
      if (clean.length !== 6) return '#000000';
      return `#${clean}`.toUpperCase();
    }

    function inputToHex(val) {
      if (!val) return undefined;
      return val.replace('#', '').toUpperCase();
    }

    function applyTemplateStyle(templateId) {
      const style = templatesCache[templateId] || {};
      
      // H1
      document.getElementById('fontHeader1').value = style.fontHeader1 || '';
      document.getElementById('fontSizeH1').value = style.fontSizeH1 || '';
      document.getElementById('colorHeader1').value = hexToInput(style.colorHeader1 || (style.redHeader ? 'FF0000' : '000000'));
      
      // H2
      document.getElementById('fontHeader2').value = style.fontHeader2 || '';
      document.getElementById('fontSizeH2').value = style.fontSizeH2 || '';
      document.getElementById('colorHeader2').value = hexToInput(style.colorHeader2 || '000000');

      // H3
      document.getElementById('fontHeader3').value = style.fontHeader3 || '';
      document.getElementById('fontSizeH3').value = style.fontSizeH3 || '';
      document.getElementById('colorHeader3').value = hexToInput(style.colorHeader3 || '000000');

      // Main
      document.getElementById('fontMain').value = style.fontMain || '';
      document.getElementById('fontSizeMain').value = style.fontSizeMain || '';
      document.getElementById('colorMain').value = hexToInput(style.colorMain || '000000');
      document.getElementById('lineSpacing').value = style.lineSpacing || '';
      
      // Margins
      document.getElementById('marginTop').value = style.margin && style.margin.top ? style.margin.top : '';
      document.getElementById('marginBottom').value = style.margin && style.margin.bottom ? style.margin.bottom : '';
      document.getElementById('marginLeft').value = style.margin && style.margin.left ? style.margin.left : '';
      document.getElementById('marginRight').value = style.margin && style.margin.right ? style.margin.right : '';
      
      // Table
      const tbl = style.table || {};
      document.getElementById('tableBorderStyle').value = tbl.borderStyle || '';
      document.getElementById('tableBorderColor').value = hexToInput(tbl.borderColor || '000000');
      document.getElementById('tableBorderSize').value = tbl.borderSize || '';
      document.getElementById('tableHeaderBold').checked = tbl.headerBold === true;
      document.getElementById('tableHeaderColor').value = hexToInput(tbl.headerColor || '000000');
      document.getElementById('tableCellAlign').value = tbl.cellAlign || '';
    }

    function buildStyleConfig() {
      const templateId = templateSelect.value;
      const base = { ...(templatesCache[templateId] || {}) };
      const overrides = {
        fontHeader1: document.getElementById('fontHeader1').value.trim() || undefined,
        fontSizeH1: Number(document.getElementById('fontSizeH1').value) || undefined,
        colorHeader1: inputToHex(document.getElementById('colorHeader1').value),
        
        fontHeader2: document.getElementById('fontHeader2').value.trim() || undefined,
        fontSizeH2: Number(document.getElementById('fontSizeH2').value) || undefined,
        colorHeader2: inputToHex(document.getElementById('colorHeader2').value),

        fontHeader3: document.getElementById('fontHeader3').value.trim() || undefined,
        fontSizeH3: Number(document.getElementById('fontSizeH3').value) || undefined,
        colorHeader3: inputToHex(document.getElementById('colorHeader3').value),

        fontMain: document.getElementById('fontMain').value.trim() || undefined,
        fontSizeMain: Number(document.getElementById('fontSizeMain').value) || undefined,
        colorMain: inputToHex(document.getElementById('colorMain').value),
        lineSpacing: Number(document.getElementById('lineSpacing').value) || undefined,
        margin: {
          top: document.getElementById('marginTop').value || undefined,
          bottom: document.getElementById('marginBottom').value || undefined,
          left: document.getElementById('marginLeft').value || undefined,
          right: document.getElementById('marginRight').value || undefined,
        },
        table: {
          borderStyle: document.getElementById('tableBorderStyle').value || undefined,
          borderColor: inputToHex(document.getElementById('tableBorderColor').value),
          borderSize: Number(document.getElementById('tableBorderSize').value) || undefined,
          headerBold: document.getElementById('tableHeaderBold').checked,
          headerColor: inputToHex(document.getElementById('tableHeaderColor').value),
          cellAlign: document.getElementById('tableCellAlign').value || undefined,
        }
      };
      Object.keys(overrides).forEach(k => {
        if (overrides[k] === undefined || overrides[k] === 'NaN') delete overrides[k];
      });
      if (overrides.margin) {
        const m = overrides.margin;
        if (!m.top && !m.bottom && !m.left && !m.right) delete overrides.margin;
      }
      if (overrides.table) {
        const t = overrides.table;
        Object.keys(t).forEach(k => { if (t[k] === undefined || t[k] === 'NaN') delete t[k]; });
        if (Object.keys(overrides.table).length === 0) delete overrides.table;
      }
      return { ...base, ...overrides };
    }

    templateSelect.addEventListener('change', (e) => {
      applyTemplateStyle(e.target.value);
    });
    document.getElementById('toggleStyleBtn').addEventListener('click', toggleStyleEditor);

    loadTemplates();
  </script>
</body>
</html>