<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocxJS Pro Editor</title>
  <script src="vendor/jszip/jszip.min.js"></script>
  <script src="vendor/docx-preview/docx-preview.min.js"></script>
  <script src="vendor/html2canvas/html2canvas.min.js"></script>
  <script src="vendor/jspdf/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="fonts.css">
  <style>
    
    :root {
      /* Theme Variables */
      --bg-app: #F3F4F6;
      --bg-panel: #FFFFFF;
      --bg-input: #F9FAFB;
      --primary: #2563EB;
      --primary-hover: #1D4ED8;
      --text-main: #1F2937;
      --text-sub: #6B7280;
      --border: #E5E7EB;
      --sidebar-width: 380px;
      --header-height: 56px;
      
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-paper: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-app);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Print Styles */
    @media print {
      body * { visibility: hidden; }
      #paper-container, #paper-container * { visibility: visible; }
      #htmlPreview, #htmlPreview * { visibility: visible; }
      
      #paper-container { position: absolute; left: 0; top: 0; margin: 0; padding: 0; transform: none !important; }
      #htmlPreview { position: absolute; left: 0; top: 0; margin: 0; padding: 0; transform: none !important; width: 100% !important; box-shadow: none !important; }
      
      header, nav, aside, .action-bar, .preview-toolbar { display: none !important; }
      .app-body { height: auto; overflow: visible; }
      main.preview-stage { background: white; overflow: visible; padding: 0; }
      .canvas-scroll { padding: 0; overflow: visible; display: block; }
      /* Ensure pages break correctly */
      .docx-wrapper > section.docx { page-break-after: always; box-shadow: none !important; margin: 0 !important; }
    }

    /* Header */
    header {
      height: var(--header-height);
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 10;
    }
    
    .brand { font-weight: 600; font-size: 18px; display: flex; align-items: center; gap: 8px; }
    .brand svg { color: var(--primary); }

    /* Main Tabs */
    .main-tabs {
        display: flex;
        background: white;
        border-bottom: 1px solid var(--border);
        padding: 0 20px;
        gap: 20px;
        flex-shrink: 0;
    }
    .tab-item {
        padding: 12px 0;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-sub);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }
    .tab-item:hover { color: var(--primary); }
    .tab-item.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }
    
    /* Actions & Buttons */
    .btn {
      height: 32px;
      padding: 0 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn:hover { background: var(--bg-input); }
    .btn-primary {
      background: var(--primary);
      border-color: transparent;
      color: white;
    }
    .btn-primary:hover { background: var(--primary-hover); }

    /* Layout Containers */
    .view-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      /* Height handled by flex parent (body) */
    }

    /* Sidebar */
    aside {
      width: var(--sidebar-width);
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .scroll-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Form Controls */
    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-sub);
      text-transform: uppercase;
      margin: 24px 0 12px;
      letter-spacing: 0.05em;
    }
    .section-title:first-child { margin-top: 0; }

    .control-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-main);
    }
    
    input[type="text"], input[type="number"], select, textarea {
      width: 100%;
      height: 36px;
      padding: 0 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      color: var(--text-main);
      background: var(--bg-input);
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    /* Accordion Details */
    details {
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 12px;
      background: white;
      overflow: hidden;
    }
    details summary {
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-input);
      user-select: none;
    }
    details summary:hover { background: #F3F4F6; }
    details[open] summary { border-bottom: 1px solid var(--border); }
    
    .details-content { padding: 16px; }

    /* Grid for Inputs */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }

    /* Color Picker */
    .color-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    input[type="color"] {
      width: 36px;
      height: 36px;
      padding: 2px;
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      margin-right: 8px;
    }

    /* Tabs (Sidebar) */
    .tabs { display: flex; gap: 4px; background: var(--bg-input); padding: 4px; border-radius: 8px; margin-bottom: 16px; }
    .tab {
      flex: 1;
      text-align: center;
      padding: 6px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-sub);
    }
    .tab.active { background: white; color: var(--primary); box-shadow: var(--shadow-sm); }

    /* Preview Stage */
    main.preview-stage {
      flex: 1;
      background: #525659;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .action-bar {
        height: 48px;
        background: white;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 12px;
        justify-content: flex-end; /* Right align buttons */
        flex-shrink: 0;
    }
    
    .toolbar-title {
        margin-right: auto;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-main);
    }

    .preview-toolbar {
      height: 32px;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: white;
      font-size: 12px;
      backdrop-filter: blur(4px);
      flex-shrink: 0;
    }

    .canvas-scroll {
      flex: 1;
      overflow: auto;
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    #paper-container {
      background: transparent;
      box-shadow: none;
      min-height: 297mm; /* A4 Height */
      width: 210mm;      /* A4 Width */
      transform-origin: top center;
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    /* Ensure all rendered pages stay on white sheets */
    #paper-container .docx-wrapper {
      background: transparent !important;
      padding: 0 !important;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    #paper-container .docx-wrapper > section.docx,
    #paper-container > section.docx {
      background: white !important;
      box-shadow: var(--shadow-paper);
      margin: 0;
    }

    #paper-container .docx-wrapper > section.docx:last-child,
    #paper-container > section.docx:last-child {
      margin-bottom: 0;
    }

    /* HTML Preview container */
    #htmlPreview {
      background: white;
      width: 900px; /* Expanded for document-style layouts */
      min-height: 1123px;
      margin: 0 auto;
      padding: 0; /* Let document content handle padding */
      box-shadow: var(--shadow-paper);
      border-radius: 8px;
      color: #111827;
      /* overflow: hidden; Removed to allow iframe expansion */
      display: flex; /* Ensure iframe fills it */
      flex-direction: column;
    }
    #htmlPreview table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
    }
    #htmlPreview table, #htmlPreview th, #htmlPreview td {
      border: 1px solid #e5e7eb;
    }
    #htmlPreview th, #htmlPreview td {
      padding: 8px;
      text-align: left;
    }

    /* Modal / Editor Overlay */
    #editorContainer {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: #e5e7eb;
        z-index: 100;
        display: none;
        flex-direction: column;
        padding: 20px;
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
      DocxJS Editor
    </div>
  </header>

  <!-- Navigation Tabs -->
  <nav class="main-tabs">
    <div class="tab-item active" id="tab-md" onclick="setMode('markdown')">Markdown & Docx</div>
    <div class="tab-item" id="tab-html" onclick="setMode('html')">HTML Preview</div>
  </nav>

  <!-- Markdown View (Sidebar + Preview) -->
  <div id="view-markdown" class="view-container">
    <aside>
      <div class="scroll-container">
        <div class="control-group">
          <label>é€‰æ‹©åŸºç¡€æ¨¡æ¿</label>
          <select id="templateSelect">
            <option value="">Loading...</option>
          </select>
        </div>

        <div class="section-title">æ ·å¼å¾®è°ƒ</div>

        <!-- Global -->
        <details open>
          <summary>é¡µé¢ä¸è¾¹è· (Global)</summary>
          <div class="details-content">
            <label>é¡µè¾¹è· (ä¸Šä¸‹å·¦å³ - twips)</label>
            <div class="grid-4">
              <input type="number" id="marginTop" placeholder="ä¸Š">
              <input type="number" id="marginBottom" placeholder="ä¸‹">
              <input type="number" id="marginLeft" placeholder="å·¦">
              <input type="number" id="marginRight" placeholder="å³">
            </div>
            <div style="margin-top:12px;">
              <label>å‚è€ƒæ–‡æ¡£æå–æ ·å¼</label>
              <input type="file" id="refDocInput" accept=".docx">
            </div>
          </div>
        </details>

        <!-- Headings -->
        <details>
          <summary>æ ‡é¢˜æ ·å¼ (Headings)</summary>
          <div class="details-content">
            <div class="tabs" id="headingTabs">
              <div class="tab active" data-target="h1">ä¸€çº§æ ‡é¢˜</div>
              <div class="tab" data-target="h2">äºŒçº§æ ‡é¢˜</div>
              <div class="tab" data-target="h3">ä¸‰çº§æ ‡é¢˜</div>
              <div class="tab" data-target="h4">å››çº§</div>
              <div class="tab" data-target="h5">äº”çº§</div>
              <div class="tab" data-target="h6">å…­çº§</div>
            </div>

            <!-- H1 Controls -->
            <div id="h1-controls" class="style-pane">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader1">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH1" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH1">
                </div>
              </div>
              <div class="grid-2" style="margin-top:8px;">
                <div>
                    <label>é¢œè‰²</label>
                    <div class="color-wrapper">
                      <input type="color" id="colorHeader1">
                      <input type="text" id="colorHeader1Text" placeholder="#000000">
                    </div>
                </div>
                <div>
                    <label>å¯¹é½æ–¹å¼</label>
                    <select id="titleAlignment">
                        <option value="">é»˜è®¤</option>
                        <option value="left">å·¦å¯¹é½</option>
                        <option value="center">å±…ä¸­</option>
                        <option value="right">å³å¯¹é½</option>
                    </select>
                </div>
              </div>
            </div>

            <!-- H2 Controls -->
            <div id="h2-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader2">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH2" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH2">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader2">
                  <input type="text" id="colorHeader2Text" placeholder="#000000">
                </div>
              </div>
            </div>

            <!-- H3 Controls -->
            <div id="h3-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader3">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH3" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH3">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader3">
                  <input type="text" id="colorHeader3Text" placeholder="#000000">
                </div>
              </div>
            </div>

            <!-- H4 Controls -->
            <div id="h4-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader4">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH4" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH4">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader4">
                  <input type="text" id="colorHeader4Text" placeholder="#000000">
                </div>
              </div>
            </div>

            <!-- H5 Controls -->
            <div id="h5-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader5">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH5" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH5">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader5">
                  <input type="text" id="colorHeader5Text" placeholder="#000000">
                </div>
              </div>
            </div>

            <!-- H6 Controls -->
            <div id="h6-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader6">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH6" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH6">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader6">
                  <input type="text" id="colorHeader6Text" placeholder="#000000">
                </div>
              </div>
            </div>
          </div>
        </details>

        <!-- Body -->
        <details>
          <summary>æ­£æ–‡æ’ç‰ˆ (Body)</summary>
          <div class="details-content">
            <div class="grid-2">
              <div>
                <label>å­—ä½“</label>
                <input type="text" id="fontMain">
              </div>
              <div>
                <label>å­—å· <span id="chineseFontSizeMain" class="chinese-font-size"></span></label>
                <input type="number" id="fontSizeMain">
              </div>
            </div>
            <div class="grid-2" style="margin-top:8px;">
               <div>
                   <label>è¡Œè· (Line Spacing)</label>
                   <input type="number" id="lineSpacing">
               </div>
               <div>
                   <label>é¦–è¡Œç¼©è¿› (twips)</label>
                   <input type="number" id="paragraphIndent" placeholder="å¦‚: 640">
               </div>
            </div>
          </div>
        </details>

        <!-- Table -->
        <details>
          <summary>è¡¨æ ¼æ ·å¼ (Table)</summary>
          <div class="details-content">
             <label>è¾¹æ¡†é£æ ¼</label>
             <select id="tableBorderStyle">
               <option value="">é»˜è®¤</option>
               <option value="single">å•å®çº¿</option>
               <option value="dotted">ç‚¹çº¿</option>
               <option value="none">æ— è¾¹æ¡†</option>
             </select>
             
             <div class="grid-2" style="margin-top:8px;">
               <div>
                 <label>è¾¹æ¡†ç²—ç»†</label>
                 <input type="number" id="tableBorderSize">
               </div>
               <div>
                  <label>è¾¹æ¡†é¢œè‰²</label>
                  <div class="color-wrapper">
                    <input type="color" id="tableBorderColor">
                  </div>
               </div>
             </div>
             
             <div style="margin-top:8px;">
               <label>
                 <input type="checkbox" id="tableHeaderBold"> è¡¨å¤´åŠ ç²—
               </label>
             </div>
          </div>
        </details>

        <!-- Professional Mode -->
        <details id="professionalModeDetails">
            <summary>ä¸“ä¸šæ¨¡å¼ (Professional JSON)</summary>
            <div class="details-content">
                <div style="margin-bottom:8px; font-size:12px; color:#666;">
                    ç›´æ¥ç¼–è¾‘å½“å‰æ ·å¼çš„ JSON é…ç½®ã€‚ä¿®æ”¹å³æ—¶ç”Ÿæ•ˆï¼Œä½†ä¸ä¼šä¿å­˜åˆ°æ¨¡æ¿æ–‡ä»¶ã€‚
                </div>
                <textarea id="jsonConfigEditor" style="height:300px; font-family:monospace; font-size:12px; white-space:pre;"></textarea>
                <div style="margin-top:8px; text-align:right;">
                    <button class="btn btn-primary" id="applyJsonBtn" style="font-size:12px; padding:4px 12px; height:28px;">åº”ç”¨ (Apply)</button>
                </div>
            </div>
        </details>

      </div>
    </aside>

    <main class="preview-stage">
      <!-- Markdown Action Bar -->
      <div class="action-bar">
         <span class="toolbar-title">Markdown Preview</span>
         <label for="headerFileInput" class="btn" style="cursor:pointer;">
           ğŸ“„ å¯¼å…¥æ–‡ä»¶
           <input id="headerFileInput" type="file" accept=".md,.txt,.docx" style="display:none;">
         </label>
         <button class="btn" id="editMdBtn">ğŸ“ ç¼–è¾‘å†…å®¹</button>
         <button class="btn" id="exportImgBtnMD">ğŸ–¼ å¯¼å‡ºé•¿å›¾</button>
         <button class="btn" id="exportPdfBtnMD">ğŸ“„ å¯¼å‡º PDF</button>
         <button class="btn btn-primary" id="downloadBtn">â¬‡ å¯¼å‡º Docx</button>
      </div>

      <div class="preview-toolbar">
        <span id="statusText">Ready</span>
      </div>
      
      <div class="canvas-scroll" id="previewContainerMD">
        <div id="paper-container"></div>
      </div>
    </main>
  </div>

  <!-- HTML View (Full Width) -->
  <div id="view-html" class="view-container" style="display:none;">
    <main class="preview-stage" style="width:100%">
      <!-- HTML Action Bar -->
      <div class="action-bar">
         <span class="toolbar-title">HTML Preview</span>
         <button class="btn" id="importHtmlBtn">ğŸŒ å¯¼å…¥ HTML</button>
         <button class="btn" id="loadSampleHtmlBtn">ğŸ’¡ è½½å…¥ç¤ºä¾‹</button>
         <input id="htmlFileInput" type="file" accept=".html,.htm" style="display:none;">
         <button class="btn" id="editHtmlBtn">ğŸ“ ç¼–è¾‘æºç </button>
         <button class="btn" id="exportImgBtnHTML">ğŸ–¼ å¯¼å‡ºé•¿å›¾</button>
         <button class="btn" id="exportPdfBtnHTML">ğŸ“„ å¯¼å‡º PDF</button>
      </div>
      
      <div class="preview-toolbar">
         <span id="statusTextHTML">Ready</span>
      </div>

      <div class="canvas-scroll" id="previewContainerHTML">
         <div id="htmlPreview"></div>
      </div>
    </main>
  </div>

  <!-- Editor Overlay (Shared) -->
  <div id="editorContainer">
     <div style="flex:1; display:flex; flex-direction:column; background:white; border-radius:8px; box-shadow:var(--shadow-sm); overflow:hidden;">
        <div style="padding:10px 15px; border-bottom:1px solid #eee; background:#f9fafb; font-weight:500; font-size:13px; color:#374151;">
          Source Editor <span id="editorModeLabel" style="margin-left:8px; font-weight:normal; color:#666;"></span>
        </div>
        <textarea id="inlineEditor" style="flex:1; width:100%; border:none; padding:15px; font-family:'Menlo', 'Monaco', 'Courier New', monospace; resize:none; font-size:14px; line-height:1.6; outline:none; box-shadow:none; border-radius:0;"></textarea>
        <div style="padding:12px 15px; border-top:1px solid #eee; background:#f9fafb; display:flex; gap:10px; justify-content:flex-end;">
          <button class="btn" id="cancelInlineEdit">å–æ¶ˆ (Cancel)</button>
          <button class="btn btn-primary" id="saveInlineEdit">ä¿å­˜å¹¶é¢„è§ˆ (Save & Preview)</button>
        </div>
     </div>
  </div>

  <script src="api-adapter.js"></script>
  <script>
    // --- Chinese Font Size Mapping ---
    const ptToChineseMap = {
      42: "åˆå·",
      36: "å°åˆ",
      26: "ä¸€å·",
      24: "å°ä¸€",
      22: "äºŒå·",
      18: "å°äºŒ",
      16: "ä¸‰å·",
      15: "å°ä¸‰",
      14: "å››å·",
      12: "å°å››",
      10.5: "äº”å·",
      9: "å°äº”",
      7.5: "å…­å·",
      6.5: "å°å…­"
    };

    function getChineseFontSize(pt) {
      const val = parseFloat(pt);
      return ptToChineseMap[val] ? `(${ptToChineseMap[val]})` : '';
    }

    // --- State ---
    let templatesCache = {};
    let currentStyleConfig = {};
    let debounceTimer = null;
    let currentMode = 'markdown'; // 'markdown' | 'html'
    
        // Initial content
        window.markdownContent = `# ç¤ºä¾‹æ–‡æ¡£ (Mermaid æ”¯æŒ)

è¿™æ˜¯æ–‡æ¡£çš„æ­£æ–‡éƒ¨åˆ†ã€‚æ­¤å¤„å±•ç¤ºäº†**ç²—ä½“**ã€*æ–œä½“*ä»¥åŠæ™®é€šæ–‡æœ¬çš„è¡Œè·å’Œå­—ä½“æ•ˆæœã€‚é€šè¿‡ä¿®æ”¹å·¦ä¾§çš„æ ·å¼é…ç½®ï¼Œæ‚¨å¯ä»¥å®æ—¶é¢„è§ˆæ­£æ–‡çš„å­—ä½“ã€å­—å·ã€é¢œè‰²å’Œè¡Œé—´è·çš„å˜åŒ–ã€‚

## æµç¨‹å›¾æ ·ä¾‹ (Mermaid)
DocxJS ç°åœ¨æ”¯æŒå°† Mermaid å›¾è¡¨æ¸²æŸ“ä¸ºé«˜æ¸…å›¾ç‰‡å¹¶åµŒå…¥æ–‡æ¡£ã€‚

\`\`\`mermaid
graph TD
    Start((å¼€å§‹)) --> Init[åˆå§‹åŒ–é…ç½®]
    Init --> Check{æ£€æŸ¥ä¾èµ–}
    Check -- é€šè¿‡ --> Render[æœ¬åœ°æ¸²æŸ“]
    Check -- å¤±è´¥ --> Error[è®°å½•æ—¥å¿—]
    Render --> Docx[ç”Ÿæˆæ–‡æ¡£]
    Error --> Stop((ç»“æŸ))
    Docx --> Stop
\`\`\`

## åˆ—è¡¨ä¸è¡¨æ ¼å±•ç¤º

ä¸‹é¢æ˜¯ä¸€ä¸ªæ— åºåˆ—è¡¨ï¼š
- åˆ—è¡¨é¡¹ 1ï¼šæµ‹è¯•ç¼©è¿›å’Œå¯¹é½
- åˆ—è¡¨é¡¹ 2ï¼šæµ‹è¯•å­—ä½“ä¸€è‡´æ€§
- åˆ—è¡¨é¡¹ 3ï¼šåŒ…å« **ç²—ä½“** çš„åˆ—è¡¨é¡¹

ä¸‹é¢æ˜¯ä¸€ä¸ªè¡¨æ ¼æ ·å¼çš„å±•ç¤ºï¼š

| åºå· | é¡¹ç›®åç§° | çŠ¶æ€ | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- |
| 1 | ç³»ç»Ÿæ¶æ„è®¾è®¡ | å®Œæˆ | æ ¸å¿ƒæ¨¡å— |
| 2 | Mermaid æ¸²æŸ“ | å®Œæˆ | ç¦»çº¿æ”¯æŒ |
| 3 | åç«¯æ¥å£è”è°ƒ | è¿›è¡Œä¸­ | API å¯¹æ¥ |

# Sample Document (Mermaid Support)

This document demonstrates **bold**, *italic*, and Mermaid diagram support.

## Flowchart Example
DocxJS renders Mermaid diagrams offline as high-quality images.

\`\`\`mermaid
graph LR
    User[User] -->|Input| App[Desktop App]
    App -->|Parse| Engine[Core Engine]
    Engine -->|Render| Word[Docx File]
\`\`\`

## Lists and Tables Display

Below is an unordered list:
- List Item 1: Testing indentation
- List Item 2: Testing font consistency

Here is a demonstration of table styling:

| No. | Item Name | Status | Remarks |
| :--- | :--- | :--- | :--- |
| 1 | System Architecture | Completed | Core Module |
| 2 | Mermaid Support | Completed | Offline |
| 3 | API Integration | In Progress | Connectivity |`;
        window.htmlContent = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
  body { font-family: sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: auto; padding: 20px; }
  h1 { color: #2563eb; border-bottom: 2px solid #eee; padding-bottom: 10px; }
  h2 { color: #1e40af; margin-top: 30px; }
  table { width: 100%; border-collapse: collapse; margin: 20px 0; }
  th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
  th { background-color: #f8fafc; font-weight: 600; }
  .highlight { background-color: #fef9c3; padding: 2px 4px; border-radius: 4px; }
  .info-box { background-color: #eff6ff; border-left: 4px solid #3b82f6; padding: 15px; margin: 20px 0; }
  img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
</style>
</head>
<body>

<h1>HTML é¢„è§ˆåŠŸèƒ½æ¼”ç¤º (Sample)</h1>

<p>è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯• <strong>DocxJS Pro</strong> HTML é¢„è§ˆä¸å¯¼å‡ºåŠŸèƒ½çš„æ ·ä¾‹æ–‡ä»¶ã€‚å®ƒåŒ…å«äº†å¸¸è§çš„ç½‘é¡µå…ƒç´ åŠåŸºç¡€çš„ CSS æ ·å¼æ”¯æŒã€‚</p>

<div class="info-box">
  <strong>æç¤ºï¼š</strong> æ‚¨å¯ä»¥ç›´æ¥åœ¨ç¼–è¾‘å™¨ä¸­ä¿®æ”¹æ­¤ HTML çš„æºç ï¼Œé¢„è§ˆåŒºåŸŸå°†å®æ—¶æ›´æ–°ã€‚
</div>

<h2>1. æ–‡æœ¬æ ·å¼</h2>
<p>æ”¯æŒå¸¸è§çš„ HTML æ ‡ç­¾ï¼š</p>
<ul>
  <li><strong>åŠ ç²—æ–‡æœ¬</strong> (strong)</li>
  <li><em>æ–œä½“æ–‡æœ¬</em> (em)</li>
  <li><span class="highlight">å¸¦èƒŒæ™¯è‰²çš„é«˜äº®æ–‡æœ¬</span> (span with style)</li>
  <li><a href="#">è¶…é“¾æ¥æµ‹è¯•</a></li>
</ul>

<h2>2. æ•°æ®è¡¨æ ¼</h2>
<p>æ”¯æŒå¤æ‚çš„è¡¨æ ¼å¸ƒå±€å’Œæ ·å¼å®šä¹‰ï¼š</p>

<table>
  <thead>
    <tr>
      <th>é¡¹ç›®é˜¶æ®µ</th>
      <th>è´Ÿè´£äºº</th>
      <th>çŠ¶æ€</th>
      <th>è¿›åº¦</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>éœ€æ±‚åˆ†æ</td>
      <td>å¼ ä¸‰</td>
      <td><span style="color: #059669;">å·²å®Œæˆ</span></td>
      <td>100%</td>
    </tr>
    <tr>
      <td>åŸå‹è®¾è®¡</td>
      <td>æå››</td>
      <td><span style="color: #d97706;">è¿›è¡Œä¸­</span></td>
      <td>65%</td>
    </tr>
    <tr>
      <td>æ ¸å¿ƒå¼€å‘</td>
      <td>ç‹äº”</td>
      <td><span style="color: #dc2626;">å¾…å¯åŠ¨</span></td>
      <td>0%</td>
    </tr>
  </tbody>
</table>

<h2>3. åª’ä½“å…ƒç´ </h2>
<p>æ”¯æŒå¤–é“¾å›¾ç‰‡å±•ç¤ºï¼š</p>
<p style="text-align: center;">
  <img src="https://images.unsplash.com/photo-1586281380349-632531db7ed4?auto=format&fit=crop&w=800&q=80" alt="Office Work">
  <br>
  <small style="color: #666;">å›¾ 1ï¼šè¿œç¨‹åä½œåŠå…¬åœºæ™¯ç¤ºæ„å›¾</small>
</p>

<h2>4. åˆ—è¡¨å±•ç¤º</h2>
<ol>
  <li>ç¬¬ä¸€æ­¥ï¼šå¯¼å…¥ HTML æ–‡ä»¶æˆ–ç²˜è´´æºç </li>
  <li>ç¬¬äºŒæ­¥ï¼šåœ¨é¢„è§ˆçª—å£ç¡®è®¤æ ·å¼</li>
  <li>ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»â€œå¯¼å‡ºé•¿å›¾â€æˆ–â€œå¯¼å‡º PDFâ€</li>
</ol>

</body>
</html>`;
    
        // --- Elements ---
        const els = {
          templateSelect: document.getElementById('templateSelect'),
          paper: document.getElementById('paper-container'),
          status: document.getElementById('statusText'),
          statusHTML: document.getElementById('statusTextHTML'),
          inputs: document.querySelectorAll('input, select'), 
          
          // Layout Tabs
          tabMD: document.getElementById('tab-md'),
          tabHTML: document.getElementById('tab-html'),
          viewMD: document.getElementById('view-markdown'),
          viewHTML: document.getElementById('view-html'),
          
          // Markdown Actions
          downloadBtn: document.getElementById('downloadBtn'),
          headerFileInput: document.getElementById('headerFileInput'),
          editMdBtn: document.getElementById('editMdBtn'),
          exportImgBtnMD: document.getElementById('exportImgBtnMD'),
          exportPdfBtnMD: document.getElementById('exportPdfBtnMD'),
          refDocInput: document.getElementById('refDocInput'),
    
          // HTML Actions
          importHtmlBtn: document.getElementById('importHtmlBtn'),
          loadSampleHtmlBtn: document.getElementById('loadSampleHtmlBtn'),
          htmlFileInput: document.getElementById('htmlFileInput'),
          editHtmlBtn: document.getElementById('editHtmlBtn'),
          exportImgBtnHTML: document.getElementById('exportImgBtnHTML'),
          exportPdfBtnHTML: document.getElementById('exportPdfBtnHTML'),
          htmlPreview: document.getElementById('htmlPreview'),      
      // Editor
      editorContainer: document.getElementById('editorContainer'),
      inlineEditor: document.getElementById('inlineEditor'),
      editorModeLabel: document.getElementById('editorModeLabel'),
      saveInlineEdit: document.getElementById('saveInlineEdit'),
      cancelInlineEdit: document.getElementById('cancelInlineEdit'),
      
      // Professional Mode
      jsonConfigEditor: document.getElementById('jsonConfigEditor'),
      applyJsonBtn: document.getElementById('applyJsonBtn'),
      professionalModeDetails: document.getElementById('professionalModeDetails')
    };

    // --- Initialization ---
    async function init() {
      try {
        const templates = await API.getTemplates();
        els.templateSelect.innerHTML = '';
        templates.forEach(t => {
          templatesCache[t.id] = t.style || {};
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.id + (t.description ? ` - ${t.description}` : '');
          els.templateSelect.appendChild(opt);
        });
        
        // Trigger initial load
        if (templates.length > 0) {
            const initialId = templates[0].id;
            currentStyleConfig = JSON.parse(JSON.stringify(templatesCache[initialId])); // Deep copy
            applyValuesFromConfig(currentStyleConfig);
            triggerPreview();
        }
      } catch (e) {
        console.error(e);
        els.status.textContent = "Error loading templates";
      }
    }
    
    // --- Mode Switching ---
    window.setMode = function(mode) {
        currentMode = mode;
        if(mode === 'html') {
            els.tabMD.classList.remove('active');
            els.tabHTML.classList.add('active');
            els.viewMD.style.display = 'none';
            els.viewHTML.style.display = 'flex';
        } else {
            els.tabHTML.classList.remove('active');
            els.tabMD.classList.add('active');
            els.viewHTML.style.display = 'none';
            els.viewMD.style.display = 'flex';
        }
        triggerPreview();
    }

    // --- Logic ---
    // sanitizeHtml function removed/bypassed as per request for raw browser preview
    
    function buildConfigFromInputs() {
      const getVal = (id) => document.getElementById(id).value;
      const getNum = (id) => Number(document.getElementById(id).value) || undefined;
      const getCol = (id) => document.getElementById(id).value; // Hex
      
      const getHalfPt = (id) => {
          const val = getNum(id);
          return val !== undefined ? val * 2 : undefined;
      };

      const base = JSON.parse(JSON.stringify(currentStyleConfig || {}));

      const uiConfig = {
        fontHeader1: getVal('fontHeader1') || undefined,
        fontSizeH1: getHalfPt('fontSizeH1'),
        colorHeader1: inputToHex(getCol('colorHeader1')),
        titleAlignment: getVal('titleAlignment') || undefined,

        fontHeader2: getVal('fontHeader2') || undefined,
        fontSizeH2: getHalfPt('fontSizeH2'),
        colorHeader2: inputToHex(getCol('colorHeader2')),

        fontHeader3: getVal('fontHeader3') || undefined,
        fontSizeH3: getHalfPt('fontSizeH3'),
        colorHeader3: inputToHex(getCol('colorHeader3')),

        fontHeader4: getVal('fontHeader4') || undefined,
        fontSizeH4: getHalfPt('fontSizeH4'),
        colorHeader4: inputToHex(getCol('colorHeader4')),

        fontHeader5: getVal('fontHeader5') || undefined,
        fontSizeH5: getHalfPt('fontSizeH5'),
        colorHeader5: inputToHex(getCol('colorHeader5')),

        fontHeader6: getVal('fontHeader6') || undefined,
        fontSizeH6: getHalfPt('fontSizeH6'),
        colorHeader6: inputToHex(getCol('colorHeader6')),

        fontMain: getVal('fontMain') || undefined,
        fontSizeMain: getHalfPt('fontSizeMain'),
        lineSpacing: getNum('lineSpacing'),
        paragraphIndent: getNum('paragraphIndent'),
        
        margin: {
          ...(base.margin || {}),
          top: getVal('marginTop') || undefined,
          bottom: getVal('marginBottom') || undefined,
          left: getVal('marginLeft') || undefined,
          right: getVal('marginRight') || undefined,
        },
        
        table: {
            ...(base.table || {}),
            borderStyle: getVal('tableBorderStyle') || undefined,
            borderSize: getNum('tableBorderSize'),
            borderColor: inputToHex(getCol('tableBorderColor')),
            headerBold: document.getElementById('tableHeaderBold').checked
        }
      };

      const merged = { ...base, ...uiConfig };
      merged.margin = { ...base.margin, ...uiConfig.margin };
      merged.table = { ...base.table, ...uiConfig.table };

      return merged;
    }
    
    // --- Professional Mode Logic ---
    function updateJsonEditorFromState() {
        if(els.professionalModeDetails.open) {
            els.jsonConfigEditor.value = JSON.stringify(currentStyleConfig, null, 2);
        }
    }

    els.applyJsonBtn.addEventListener('click', () => {
        try {
            const newConfig = JSON.parse(els.jsonConfigEditor.value);
            currentStyleConfig = newConfig;
            applyValuesFromConfig(currentStyleConfig);
            triggerPreview();
            alert("Configuration Applied!");
        } catch(e) {
            alert("Invalid JSON: " + e.message);
        }
    });

    els.professionalModeDetails.addEventListener('toggle', () => {
         if(els.professionalModeDetails.open) {
             updateJsonEditorFromState();
         }
    });

    function applyValuesFromConfig(style) {
      if(!style) return;
      const setVal = (id, v) => { 
        const el = document.getElementById(id); 
        if(el) el.value = (v === undefined ? '' : v); 
      };
      
      const setPt = (id, halfPtVal, displayId) => {
          const ptVal = halfPtVal ? halfPtVal / 2 : undefined;
          setVal(id, ptVal);
          const displayEl = document.getElementById(displayId);
          if (displayEl) {
              displayEl.textContent = ptVal ? getChineseFontSize(ptVal) : '';
          }
      };
      
      setVal('fontHeader1', style.fontHeader1);
      setPt('fontSizeH1', style.fontSizeH1, 'chineseFontSizeH1');
      setVal('colorHeader1', hexToInput(style.colorHeader1));
      setVal('titleAlignment', style.titleAlignment);

      setVal('fontHeader2', style.fontHeader2);
      setPt('fontSizeH2', style.fontSizeH2, 'chineseFontSizeH2');
      setVal('colorHeader2', hexToInput(style.colorHeader2));

      setVal('fontHeader3', style.fontHeader3);
      setPt('fontSizeH3', style.fontSizeH3, 'chineseFontSizeH3');
      setVal('colorHeader3', hexToInput(style.colorHeader3));

      setVal('fontHeader4', style.fontHeader4);
      setPt('fontSizeH4', style.fontSizeH4, 'chineseFontSizeH4');
      setVal('colorHeader4', hexToInput(style.colorHeader4));

      setVal('fontHeader5', style.fontHeader5);
      setPt('fontSizeH5', style.fontSizeH5, 'chineseFontSizeH5');
      setVal('colorHeader5', hexToInput(style.colorHeader5));

      setVal('fontHeader6', style.fontHeader6);
      setPt('fontSizeH6', style.fontSizeH6, 'chineseFontSizeH6');
      setVal('colorHeader6', hexToInput(style.colorHeader6));

      setVal('fontMain', style.fontMain);
      setPt('fontSizeMain', style.fontSizeMain, 'chineseFontSizeMain');
      setVal('lineSpacing', style.lineSpacing);
      setVal('paragraphIndent', style.paragraphIndent);

      if(style.margin) {
        setVal('marginTop', style.margin.top);
        setVal('marginBottom', style.margin.bottom);
        setVal('marginLeft', style.margin.left);
        setVal('marginRight', style.margin.right);
      }

      if(style.table) {
          setVal('tableBorderStyle', style.table.borderStyle);
          setVal('tableBorderSize', style.table.borderSize);
          setVal('tableBorderColor', hexToInput(style.table.borderColor));
          document.getElementById('tableHeaderBold').checked = !!style.table.headerBold;
      }
    }

    function hexToInput(hex) {
       if (!hex) return '#000000';
       return hex.startsWith('#') ? hex : '#' + hex;
    }
    function inputToHex(val) {
       return val ? val.replace('#', '').toUpperCase() : undefined;
    }

    // --- Preview Logic ---
    function triggerPreview() {
      // Logic split by mode
      if (currentMode === 'html') {
          if (els.statusHTML) els.statusHTML.textContent = "Updating Preview...";
      } else {
          if (els.status) els.status.textContent = "Updating Preview...";
      }

      if (debounceTimer) clearTimeout(debounceTimer);
      
      debounceTimer = setTimeout(async () => {
        try {
          if (currentMode === 'html') {
              const container = els.htmlPreview;
              if (!container) {
                  console.error("HTML Preview Container not found!");
                  if(els.statusHTML) els.statusHTML.textContent = "Error: HTML Container Missing";
                  return;
              }
              try {
                  // Direct Iframe Rendering (Raw Browser Preview)
                  container.innerHTML = '';
                  const iframe = document.createElement('iframe');
                  iframe.style.width = '100%';
                  iframe.style.border = 'none';
                  iframe.style.display = 'block';
                  iframe.style.minHeight = '1123px';
                  
                  iframe.onload = () => {
                      try {
                          const doc = iframe.contentDocument;
                          if(doc && doc.body) {
                              // Initial Resize
                              const updateHeight = () => {
                                  // Use scrollHeight of documentElement to catch everything
                                  const height = Math.max(
                                      doc.body.scrollHeight, 
                                      doc.body.offsetHeight,
                                      doc.documentElement.scrollHeight
                                  );
                                  iframe.style.height = height + 'px';
                                  // Update container min-height to match if needed, but iframe expansion should push it.
                              };
                              updateHeight();
                              
                              // Observe changes
                              const observer = new ResizeObserver(() => {
                                  updateHeight();
                              });
                              observer.observe(doc.body);
                              observer.observe(doc.documentElement); // Watch root as well
                          }
                      } catch(e) { console.warn("Resize frame failed", e); }
                  };

                  container.appendChild(iframe);
                  
                  const doc = iframe.contentDocument || iframe.contentWindow.document;
                  doc.open();
                  doc.write(window.htmlContent || '');
                  doc.close();

                  if (els.statusHTML) els.statusHTML.textContent = "HTML Preview Updated";
              } catch (err) {
                  console.error("Render Error:", err);
                  if (els.statusHTML) els.statusHTML.textContent = "Preview Failed: " + err.message;
              }
              return;
          }

          // Markdown Mode
          currentStyleConfig = buildConfigFromInputs();
          updateJsonEditorFromState();
          const config = currentStyleConfig;
          const blob = await API.preview(config, window.markdownContent);
          
          if (els.paper) {
              els.paper.innerHTML = '';
              await docx.renderAsync(blob, els.paper, null, {
                inWrapper: true,
                ignoreWidth: false,
                experimental: true,
                breakPages: true
              });
          }
          
          if (els.status) els.status.textContent = "Preview Updated";
        } catch (err) {
          console.error(err);
          if (currentMode === 'html') {
              if (els.statusHTML) els.statusHTML.textContent = "Error: " + err.message;
          } else {
              if (els.status) els.status.textContent = "Preview Failed: " + err.message;
          }
        }
      }, 600); 
    }

    // --- Event Listeners ---
    
    // 1. Inputs
    document.querySelectorAll('input, select').forEach(el => {
      // Exclude file inputs and editor
      if(el.type === 'file' || el.tagName === 'TEXTAREA') return;
      el.addEventListener('input', () => {
        if (el.id.startsWith('fontSizeH') || el.id === 'fontSizeMain') {
            const chineseDisplayId = 'chinese' + el.id.charAt(0).toUpperCase() + el.id.slice(1);
            const chineseDisplayEl = document.getElementById(chineseDisplayId);
            if (chineseDisplayEl) {
                chineseDisplayEl.textContent = getChineseFontSize(el.value);
            }
        }
        if(currentMode === 'markdown') triggerPreview();
      });
      el.addEventListener('change', () => {
          if(currentMode === 'markdown') triggerPreview();
      });
    });

    const fontSizeInputs = [
        'fontSizeH1', 'fontSizeH2', 'fontSizeH3', 'fontSizeH4', 'fontSizeH5', 'fontSizeH6', 'fontSizeMain'
    ];
    fontSizeInputs.forEach(id => {
        const input = document.getElementById(id);
        const chineseDisplayId = 'chinese' + id.charAt(0).toUpperCase() + id.slice(1);
        const chineseDisplayEl = document.getElementById(chineseDisplayId);
        if (input && chineseDisplayEl) {
            chineseDisplayEl.textContent = getChineseFontSize(input.value);
        }
    });

    // 2. Template Change
    els.templateSelect.addEventListener('change', (e) => {
        const tId = e.target.value;
        if(templatesCache[tId]) {
            currentStyleConfig = JSON.parse(JSON.stringify(templatesCache[tId]));
            applyValuesFromConfig(currentStyleConfig);
            triggerPreview();
        }
    });
    
    // 3. Reference Doc
    els.refDocInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        alert("Reference Doc styling will be applied during final conversion. Preview support for Reference Doc is pending backend API update.");
    });

    // 4. Tabs for Headings
    document.querySelectorAll('.tab').forEach(tab => {
        if(tab.classList.contains('tab-item')) return; // Skip main tabs
        tab.addEventListener('click', () => {
             document.querySelectorAll('#headingTabs .tab').forEach(t => t.classList.remove('active'));
             tab.classList.add('active');
             
             const target = tab.dataset.target; 
             document.querySelectorAll('.style-pane').forEach(p => p.style.display = 'none');
             document.getElementById(target + '-controls').style.display = 'block';
        });
    });

    // 5. Download Docx
    els.downloadBtn.addEventListener('click', async () => {
        const config = buildConfigFromInputs();
        els.status.textContent = "Converting...";
        try {
            const blob = await API.convert({
                markdown: window.markdownContent,
                styleConfig: config,
                filename: 'document.docx'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.docx';
            document.body.appendChild(a);
            a.click();
            a.remove();
            els.status.textContent = "Download Started";
        } catch(e) {
            alert(e.message);
            els.status.textContent = "Download Error";
        }
    });

    // 6. Import Markdown
    els.headerFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        els.status.textContent = "Loading File...";
        try {
            if (file.name.toLowerCase().endsWith('.docx')) {
                const data = await API.importDocx(file);
                window.markdownContent = data.markdown || '';
                els.status.textContent = "DOCX Imported";
            } else {
                window.markdownContent = await file.text();
                els.status.textContent = "Markdown Imported";
            }
            triggerPreview();
        } catch (err) {
            console.error(err);
            alert("Import failed: " + err.message);
            els.status.textContent = "Import Failed";
        }
        els.headerFileInput.value = '';
    });

    // 6.2 Import HTML
    els.importHtmlBtn.addEventListener('click', () => {
        els.htmlFileInput.click();
    });
    els.htmlFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
            window.htmlContent = await file.text();
            els.statusHTML.textContent = "HTML Imported";
            triggerPreview(); // in HTML mode
        } catch (err) {
            console.error(err);
            alert("HTML å¯¼å…¥å¤±è´¥: " + err.message);
            els.statusHTML.textContent = "Import Failed";
        } finally {
            els.htmlFileInput.value = '';
        }
    });

    // 6.3 Load Sample HTML
    els.loadSampleHtmlBtn.addEventListener('click', () => {
        window.htmlContent = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
  body { font-family: sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: auto; padding: 20px; }
  h1 { color: #2563eb; border-bottom: 2px solid #eee; padding-bottom: 10px; }
  h2 { color: #1e40af; margin-top: 30px; }
  table { width: 100%; border-collapse: collapse; margin: 20px 0; }
  th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
  th { background-color: #f8fafc; font-weight: 600; }
  .highlight { background-color: #fef9c3; padding: 2px 4px; border-radius: 4px; }
  .info-box { background-color: #eff6ff; border-left: 4px solid #3b82f6; padding: 15px; margin: 20px 0; }
  img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
</style>
</head>
<body>

<h1>HTML é¢„è§ˆåŠŸèƒ½æ¼”ç¤º (Sample)</h1>

<p>è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯• <strong>DocxJS Pro</strong> HTML é¢„è§ˆä¸å¯¼å‡ºåŠŸèƒ½çš„æ ·ä¾‹æ–‡ä»¶ã€‚å®ƒåŒ…å«äº†å¸¸è§çš„ç½‘é¡µå…ƒç´ åŠåŸºç¡€çš„ CSS æ ·å¼æ”¯æŒã€‚</p>

<div class="info-box">
  <strong>æç¤ºï¼š</strong> æ‚¨å¯ä»¥ç›´æ¥åœ¨ç¼–è¾‘å™¨ä¸­ä¿®æ”¹æ­¤ HTML çš„æºç ï¼Œé¢„è§ˆåŒºåŸŸå°†å®æ—¶æ›´æ–°ã€‚
</div>

<h2>1. æ–‡æœ¬æ ·å¼</h2>
<p>æ”¯æŒå¸¸è§çš„ HTML æ ‡ç­¾ï¼š</p>
<ul>
  <li><strong>åŠ ç²—æ–‡æœ¬</strong> (strong)</li>
  <li><em>æ–œä½“æ–‡æœ¬</em> (em)</li>
  <li><span class="highlight">å¸¦èƒŒæ™¯è‰²çš„é«˜äº®æ–‡æœ¬</span> (span with style)</li>
  <li><a href="#">è¶…é“¾æ¥æµ‹è¯•</a></li>
</ul>

<h2>2. æ•°æ®è¡¨æ ¼</h2>
<p>æ”¯æŒå¤æ‚çš„è¡¨æ ¼å¸ƒå±€å’Œæ ·å¼å®šä¹‰ï¼š</p>

<table>
  <thead>
    <tr>
      <th>é¡¹ç›®é˜¶æ®µ</th>
      <th>è´Ÿè´£äºº</th>
      <th>çŠ¶æ€</th>
      <th>è¿›åº¦</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>éœ€æ±‚åˆ†æ</td>
      <td>å¼ ä¸‰</td>
      <td><span style="color: #059669;">å·²å®Œæˆ</span></td>
      <td>100%</td>
    </tr>
    <tr>
      <td>åŸå‹è®¾è®¡</td>
      <td>æå››</td>
      <td><span style="color: #d97706;">è¿›è¡Œä¸­</span></td>
      <td>65%</td>
    </tr>
    <tr>
      <td>æ ¸å¿ƒå¼€å‘</td>
      <td>ç‹äº”</td>
      <td><span style="color: #dc2626;">å¾…å¯åŠ¨</span></td>
      <td>0%</td>
    </tr>
  </tbody>
</table>

<h2>3. åª’ä½“å…ƒç´ </h2>
<p>æ”¯æŒå¤–é“¾å›¾ç‰‡å±•ç¤ºï¼š</p>
<p style="text-align: center;">
  <img src="https://images.unsplash.com/photo-1586281380349-632531db7ed4?auto=format&fit=crop&w=800&q=80" alt="Office Work">
  <br>
  <small style="color: #666;">å›¾ 1ï¼šè¿œç¨‹åä½œåŠå…¬åœºæ™¯ç¤ºæ„å›¾</small>
</p>

<h2>4. åˆ—è¡¨å±•ç¤º</h2>
<ol>
  <li>ç¬¬ä¸€æ­¥ï¼šå¯¼å…¥ HTML æ–‡ä»¶æˆ–ç²˜è´´æºç </li>
  <li>ç¬¬äºŒæ­¥ï¼šåœ¨é¢„è§ˆçª—å£ç¡®è®¤æ ·å¼</li>
  <li>ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»â€œå¯¼å‡ºé•¿å›¾â€æˆ–â€œå¯¼å‡º PDFâ€</li>
</ol>

</body>
</html>`;
        triggerPreview();
        els.statusHTML.textContent = "Sample Loaded";
    });

    // 7. Edit Buttons
    els.editMdBtn.addEventListener('click', () => {
        els.editorModeLabel.textContent = "(Markdown)";
        els.inlineEditor.value = window.markdownContent;
        els.editorContainer.style.display = 'flex';
        els.inlineEditor.focus();
    });
    
    els.editHtmlBtn.addEventListener('click', () => {
        els.editorModeLabel.textContent = "(HTML)";
        els.inlineEditor.value = window.htmlContent;
        els.editorContainer.style.display = 'flex';
        els.inlineEditor.focus();
    });
    
    els.saveInlineEdit.addEventListener('click', () => {
        if (currentMode === 'html') {
            window.htmlContent = els.inlineEditor.value;
        } else {
            window.markdownContent = els.inlineEditor.value;
        }
        els.editorContainer.style.display = 'none';
        triggerPreview();
    });

    els.cancelInlineEdit.addEventListener('click', () => {
        els.editorContainer.style.display = 'none';
    });

        // 8. Capture Helpers

        window.getCaptureElement = function() {

            if (currentMode === 'html') {
                const iframe = els.htmlPreview.querySelector('iframe');
                try {
                    if (iframe && iframe.contentDocument) {
                        return iframe.contentDocument.body; 
                    }
                } catch(e) {}
                return els.htmlPreview;
            }

            const docxWrapper = document.querySelector('.docx-wrapper');

            return docxWrapper || els.paper;

        };

    

        async function exportCapture(type, mode) {

            const statusEl = mode === 'html' ? els.statusHTML : els.status;

            statusEl.textContent = "Exporting...";

            try {
                // 1. Native PDF Export (Electron) - Preferred for Fidelity
                if (type === 'pdf' && window.electronAPI) {
                     const success = await window.electronAPI.printToPDF();
                     if (success) {
                         statusEl.textContent = "PDF Exported";
                     } else {
                         statusEl.textContent = "Export Cancelled";
                     }
                     return;
                }

                // 2. Fallback / Image Export (html2canvas)
                const element = getCaptureElement();

                if (!element) throw new Error("Preview content not found");

    

                const canvas = await html2canvas(element, { 

                    scale: 2, 

                    backgroundColor: '#ffffff', 

                    useCORS: true,

                    windowWidth: element.scrollWidth,

                    windowHeight: element.scrollHeight

                });

                

                if (type === 'image') {

                    const link = document.createElement('a');

                    link.download = `export_${Date.now()}.png`;

                    link.href = canvas.toDataURL("image/png");

                    document.body.appendChild(link);

                    link.click();

                    document.body.removeChild(link);

                    statusEl.textContent = "Image Exported";

                } else if (type === 'pdf') {

                    const imgData = canvas.toDataURL('image/png');

                    const pdf = new jspdf.jsPDF('p', 'pt', 'a4');

                    const pageWidth = pdf.internal.pageSize.getWidth();

                    const pageHeight = pdf.internal.pageSize.getHeight();

                    const imgWidth = pageWidth;

                    const imgHeight = canvas.height * imgWidth / canvas.width;

    

                    let heightLeft = imgHeight;

                    let position = 0;

    

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);

                    heightLeft -= pageHeight;

    

                    while (heightLeft > 0) {

                        position = heightLeft - imgHeight;

                        pdf.addPage();

                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);

                        heightLeft -= pageHeight;

                    }

                    pdf.save(`export_${Date.now()}.pdf`);

                    statusEl.textContent = "PDF Exported";

                }

            } catch (e) {

                console.error(e);

                alert("Export Failed: " + e.message);

                statusEl.textContent = "Error";

            }

        }

    // Bind Export Buttons
    els.exportImgBtnMD.addEventListener('click', () => exportCapture('image', 'markdown'));
    els.exportPdfBtnMD.addEventListener('click', () => exportCapture('pdf', 'markdown'));
    els.exportImgBtnHTML.addEventListener('click', () => exportCapture('image', 'html'));
    els.exportPdfBtnHTML.addEventListener('click', () => exportCapture('pdf', 'html'));

    // Start
    init();

  </script>
</body>
</html>