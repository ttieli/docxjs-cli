<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocxJS Pro Editor</title>
  <script src="vendor/jszip/jszip.min.js"></script>
  <script src="vendor/docx-preview/docx-preview.min.js"></script>
  <script src="vendor/html2canvas/html2canvas.min.js"></script>
  <script src="vendor/jspdf/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="fonts.css">
  <style>
    
    :root {
      /* Theme Variables */
      --bg-app: #F3F4F6;
      --bg-panel: #FFFFFF;
      --bg-input: #F9FAFB;
      --primary: #2563EB;
      --primary-hover: #1D4ED8;
      --text-main: #1F2937;
      --text-sub: #6B7280;
      --border: #E5E7EB;
      --sidebar-width: 380px;
      --header-height: 56px;
      
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-paper: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-app);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Print Styles */
    @media print {
      body * { visibility: hidden; }
      #paper-container, #paper-container * { visibility: visible; }
      #paper-container { position: absolute; left: 0; top: 0; margin: 0; padding: 0; transform: none !important; }
      header, aside, .preview-toolbar { display: none !important; }
      .app-body { height: auto; overflow: visible; }
      main.preview-stage { background: white; overflow: visible; padding: 0; }
      .canvas-scroll { padding: 0; overflow: visible; display: block; }
      /* Ensure pages break correctly */
      .docx-wrapper > section.docx { page-break-after: always; box-shadow: none !important; margin: 0 !important; }
    }

    /* Header */
    header {
      height: var(--header-height);
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
    }
    
    .brand { font-weight: 600; font-size: 18px; display: flex; align-items: center; gap: 8px; }
    .brand svg { color: var(--primary); }
    
    .actions { display: flex; gap: 12px; }
    
    .btn {
      height: 32px;
      padding: 0 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn:hover { background: var(--bg-input); }
    .btn-primary {
      background: var(--primary);
      border-color: transparent;
      color: white;
    }
    .btn-primary:hover { background: var(--primary-hover); }

    /* Layout */
    .app-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    aside {
      width: var(--sidebar-width);
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .scroll-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Form Controls */
    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-sub);
      text-transform: uppercase;
      margin: 24px 0 12px;
      letter-spacing: 0.05em;
    }
    .section-title:first-child { margin-top: 0; }

    .control-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-main);
    }
    
    input[type="text"], input[type="number"], select, textarea {
      width: 100%;
      height: 36px;
      padding: 0 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      color: var(--text-main);
      background: var(--bg-input);
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    /* Accordion Details */
    details {
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 12px;
      background: white;
      overflow: hidden;
    }
    details summary {
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-input);
      user-select: none;
    }
    details summary:hover { background: #F3F4F6; }
    details[open] summary { border-bottom: 1px solid var(--border); }
    
    .details-content { padding: 16px; }

    /* Grid for Inputs */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }

    /* Color Picker */
    .color-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    input[type="color"] {
      width: 36px;
      height: 36px;
      padding: 2px;
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      margin-right: 8px;
    }

    /* Tabs */
    .tabs { display: flex; gap: 4px; background: var(--bg-input); padding: 4px; border-radius: 8px; margin-bottom: 16px; }
    .tab {
      flex: 1;
      text-align: center;
      padding: 6px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-sub);
    }
    .tab.active { background: white; color: var(--primary); box-shadow: var(--shadow-sm); }

    /* Preview Stage */
    main.preview-stage {
      flex: 1;
      background: #525659;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .preview-toolbar {
      height: 40px;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: white;
      font-size: 12px;
      backdrop-filter: blur(4px);
    }

    .canvas-scroll {
      flex: 1;
      overflow: auto;
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    #paper-container {
      background: transparent;
      box-shadow: none;
      min-height: 297mm; /* A4 Height */
      width: 210mm;      /* A4 Width */
      transform-origin: top center;
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    /* Ensure all rendered pages stay on white sheets */
    #paper-container .docx-wrapper {
      background: transparent !important;
      padding: 0 !important;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    #paper-container .docx-wrapper > section.docx,
    #paper-container > section.docx {
      background: white !important;
      box-shadow: var(--shadow-paper);
      margin: 0;
    }

    #paper-container .docx-wrapper > section.docx:last-child,
    #paper-container > section.docx:last-child {
      margin-bottom: 0;
    }

    /* Skeleton Loading */
    .skeleton {
      animation: pulse 1.5s infinite;
      background: #eee;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* Modal */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 100;
        display: none; justify-content: center; align-items: center;
    }
    .modal {
        background: white; padding: 24px; border-radius: 8px; width: 500px;
        box-shadow: var(--shadow-paper);
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
      DocxJS Editor
    </div>
    <div class="actions">
      <label for="headerFileInput" class="btn" style="cursor:pointer;">
        ğŸ“„ å¯¼å…¥æ–‡ä»¶
        <input id="headerFileInput" type="file" accept=".md,.txt,.docx" style="display:none;">
      </label>
      <button class="btn" id="editMdBtn">ğŸ“ ç¼–è¾‘å†…å®¹</button>
      <button class="btn" id="exportImgBtn">ğŸ–¼ å¯¼å‡ºé•¿å›¾</button>
      <button class="btn" id="exportPdfBtn">ğŸ“„ å¯¼å‡º PDF</button>
      <button class="btn btn-primary" id="downloadBtn">â¬‡ å¯¼å‡º Docx</button>
    </div>
  </header>

  <div class="app-body">
    <!-- Sidebar -->
    <aside>
      <div class="scroll-container">
        
        <div class="control-group">
          <label>é€‰æ‹©åŸºç¡€æ¨¡æ¿</label>
          <select id="templateSelect">
            <option value="">Loading...</option>
          </select>
        </div>

        <div class="section-title">æ ·å¼å¾®è°ƒ</div>

        <!-- Global -->
        <details open>
          <summary>é¡µé¢ä¸è¾¹è· (Global)</summary>
          <div class="details-content">
            <label>é¡µè¾¹è· (ä¸Šä¸‹å·¦å³ - twips)</label>
            <div class="grid-4">
              <input type="number" id="marginTop" placeholder="ä¸Š">
              <input type="number" id="marginBottom" placeholder="ä¸‹">
              <input type="number" id="marginLeft" placeholder="å·¦">
              <input type="number" id="marginRight" placeholder="å³">
            </div>
            <div style="margin-top:12px;">
              <label>å‚è€ƒæ–‡æ¡£æå–æ ·å¼</label>
              <input type="file" id="refDocInput" accept=".docx">
            </div>
          </div>
        </details>

        <!-- Headings -->
        <details>
          <summary>æ ‡é¢˜æ ·å¼ (Headings)</summary>
          <div class="details-content">
            <div class="tabs" id="headingTabs">
              <div class="tab active" data-target="h1">ä¸€çº§æ ‡é¢˜</div>
              <div class="tab" data-target="h2">äºŒçº§æ ‡é¢˜</div>
              <div class="tab" data-target="h3">ä¸‰çº§æ ‡é¢˜</div>
              <div class="tab" data-target="h4">å››çº§</div>
              <div class="tab" data-target="h5">äº”çº§</div>
              <div class="tab" data-target="h6">å…­çº§</div>
            </div>

            <!-- H1 Controls -->
            <div id="h1-controls" class="style-pane">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader1">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH1" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH1">
                </div>
              </div>
              <div class="grid-2" style="margin-top:8px;">
                <div>
                    <label>é¢œè‰²</label>
                    <div class="color-wrapper">
                      <input type="color" id="colorHeader1">
                      <input type="text" id="colorHeader1Text" placeholder="#000000">
                    </div>
                </div>
                <div>
                    <label>å¯¹é½æ–¹å¼</label>
                    <select id="titleAlignment">
                        <option value="">é»˜è®¤</option>
                        <option value="left">å·¦å¯¹é½</option>
                        <option value="center">å±…ä¸­</option>
                        <option value="right">å³å¯¹é½</option>
                    </select>
                </div>
              </div>
            </div>

            <!-- H2 Controls -->
            <div id="h2-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader2">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH2" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH2">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader2">
                  <input type="text" id="colorHeader2Text" placeholder="#000000">
                </div>
              </div>
            </div>

            <!-- H3 Controls -->
            <div id="h3-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader3">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH3" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH3">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader3">
                  <input type="text" id="colorHeader3Text" placeholder="#000000">
                </div>
              </div>
            </div>

            <!-- H4 Controls -->
            <div id="h4-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader4">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH4" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH4">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader4">
                  <input type="text" id="colorHeader4Text" placeholder="#000000">
                </div>
              </div>
            </div>

            <!-- H5 Controls -->
            <div id="h5-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader5">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH5" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH5">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader5">
                  <input type="text" id="colorHeader5Text" placeholder="#000000">
                </div>
              </div>
            </div>

            <!-- H6 Controls -->
            <div id="h6-controls" class="style-pane" style="display:none;">
              <div class="grid-2">
                <div>
                  <label>å­—ä½“</label>
                  <input type="text" id="fontHeader6">
                </div>
                <div>
                  <label>å­—å· (pt) <span id="chineseFontSizeH6" class="chinese-font-size"></span></label>
                  <input type="number" id="fontSizeH6">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label>é¢œè‰²</label>
                <div class="color-wrapper">
                  <input type="color" id="colorHeader6">
                  <input type="text" id="colorHeader6Text" placeholder="#000000">
                </div>
              </div>
            </div>
          </div>
        </details>

        <!-- Body -->
        <details>
          <summary>æ­£æ–‡æ’ç‰ˆ (Body)</summary>
          <div class="details-content">
            <div class="grid-2">
              <div>
                <label>å­—ä½“</label>
                <input type="text" id="fontMain">
              </div>
              <div>
                <label>å­—å· <span id="chineseFontSizeMain" class="chinese-font-size"></span></label>
                <input type="number" id="fontSizeMain">
              </div>
            </div>
            <div class="grid-2" style="margin-top:8px;">
               <div>
                   <label>è¡Œè· (Line Spacing)</label>
                   <input type="number" id="lineSpacing">
               </div>
               <div>
                   <label>é¦–è¡Œç¼©è¿› (twips)</label>
                   <input type="number" id="paragraphIndent" placeholder="å¦‚: 640">
               </div>
            </div>
          </div>
        </details>

        <!-- Table -->
        <details>
          <summary>è¡¨æ ¼æ ·å¼ (Table)</summary>
          <div class="details-content">
             <label>è¾¹æ¡†é£æ ¼</label>
             <select id="tableBorderStyle">
               <option value="">é»˜è®¤</option>
               <option value="single">å•å®çº¿</option>
               <option value="dotted">ç‚¹çº¿</option>
               <option value="none">æ— è¾¹æ¡†</option>
             </select>
             
             <div class="grid-2" style="margin-top:8px;">
               <div>
                 <label>è¾¹æ¡†ç²—ç»†</label>
                 <input type="number" id="tableBorderSize">
               </div>
               <div>
                  <label>è¾¹æ¡†é¢œè‰²</label>
                  <div class="color-wrapper">
                    <input type="color" id="tableBorderColor">
                  </div>
               </div>
             </div>
             
             <div style="margin-top:8px;">
               <label>
                 <input type="checkbox" id="tableHeaderBold"> è¡¨å¤´åŠ ç²—
               </label>
             </div>
          </div>
        </details>

        <!-- Professional Mode -->
        <details id="professionalModeDetails">
            <summary>ä¸“ä¸šæ¨¡å¼ (Professional JSON)</summary>
            <div class="details-content">
                <div style="margin-bottom:8px; font-size:12px; color:#666;">
                    ç›´æ¥ç¼–è¾‘å½“å‰æ ·å¼çš„ JSON é…ç½®ã€‚ä¿®æ”¹å³æ—¶ç”Ÿæ•ˆï¼Œä½†ä¸ä¼šä¿å­˜åˆ°æ¨¡æ¿æ–‡ä»¶ã€‚
                </div>
                <textarea id="jsonConfigEditor" style="height:300px; font-family:monospace; font-size:12px; white-space:pre;"></textarea>
                <div style="margin-top:8px; text-align:right;">
                    <button class="btn btn-primary" id="applyJsonBtn" style="font-size:12px; padding:4px 12px; height:28px;">åº”ç”¨ (Apply)</button>
                </div>
            </div>
        </details>

      </div>
    </aside>

    <!-- Preview Stage -->
    <main class="preview-stage">
      <div class="preview-toolbar">
        <span id="statusText">Ready</span>
        <span style="opacity:0.5">|</span>
        <span>Preview Scale: <span id="scaleVal">100%</span></span>
      </div>
      
      <!-- View Mode -->
      <div class="canvas-scroll" id="previewContainer">
        <div id="paper-container"></div>
      </div>

      <!-- Edit Mode (Hidden by default) -->
      <div id="editorContainer" style="display:none; flex:1; flex-direction:column; padding:20px; background:#e5e7eb; overflow:hidden;">
         <div style="flex:1; display:flex; flex-direction:column; background:white; border-radius:8px; box-shadow:var(--shadow-sm); overflow:hidden;">
            <div style="padding:10px 15px; border-bottom:1px solid #eee; background:#f9fafb; font-weight:500; font-size:13px; color:#374151;">
              Markdown Source
            </div>
            <textarea id="inlineMdEditor" style="flex:1; width:100%; border:none; padding:15px; font-family:'Menlo', 'Monaco', 'Courier New', monospace; resize:none; font-size:14px; line-height:1.6; outline:none; box-shadow:none; border-radius:0;"></textarea>
            <div style="padding:12px 15px; border-top:1px solid #eee; background:#f9fafb; display:flex; gap:10px; justify-content:flex-end;">
              <button class="btn" id="cancelInlineEdit">å–æ¶ˆ (Cancel)</button>
              <button class="btn btn-primary" id="saveInlineEdit">ä¿å­˜å¹¶é¢„è§ˆ (Save & Preview)</button>
            </div>
         </div>
      </div>
    </main>
  </div>



  <script src="api-adapter.js"></script>
  <script>
    // --- Chinese Font Size Mapping ---
    const ptToChineseMap = {
      42: "åˆå·",
      36: "å°åˆ",
      26: "ä¸€å·",
      24: "å°ä¸€",
      22: "äºŒå·",
      18: "å°äºŒ",
      16: "ä¸‰å·",
      15: "å°ä¸‰",
      14: "å››å·",
      12: "å°å››",
      10.5: "äº”å·",
      9: "å°äº”",
      7.5: "å…­å·",
      6.5: "å°å…­"
    };

    function getChineseFontSize(pt) {
      const val = parseFloat(pt);
      return ptToChineseMap[val] ? `(${ptToChineseMap[val]})` : '';
    }

    // --- State ---
    let templatesCache = {};
    let currentStyleConfig = {};
    let debounceTimer = null;
    // Initial sample content
    let markdownContent = `# ç¤ºä¾‹æ–‡æ¡£ (ä¸€çº§æ ‡é¢˜)

è¿™æ˜¯æ–‡æ¡£çš„æ­£æ–‡éƒ¨åˆ†ã€‚æ­¤å¤„å±•ç¤ºäº†**ç²—ä½“**ã€*æ–œä½“*ä»¥åŠæ™®é€šæ–‡æœ¬çš„è¡Œè·å’Œå­—ä½“æ•ˆæœã€‚é€šè¿‡ä¿®æ”¹å·¦ä¾§çš„æ ·å¼é…ç½®ï¼Œæ‚¨å¯ä»¥å®æ—¶é¢„è§ˆæ­£æ–‡çš„å­—ä½“ã€å­—å·ã€é¢œè‰²å’Œè¡Œé—´è·çš„å˜åŒ–ã€‚

## äºŒçº§æ ‡é¢˜æ ·ä¾‹
äºŒçº§æ ‡é¢˜é€šå¸¸ç”¨äºç« èŠ‚åˆ’åˆ†ã€‚

### ä¸‰çº§æ ‡é¢˜æ ·ä¾‹
ä¸‰çº§æ ‡é¢˜ç”¨äºæ›´ç»†è‡´çš„å†…å®¹åˆ†ç»„ã€‚

## åˆ—è¡¨ä¸è¡¨æ ¼å±•ç¤º

ä¸‹é¢æ˜¯ä¸€ä¸ªæ— åºåˆ—è¡¨ï¼š
- åˆ—è¡¨é¡¹ 1ï¼šæµ‹è¯•ç¼©è¿›å’Œå¯¹é½
- åˆ—è¡¨é¡¹ 2ï¼šæµ‹è¯•å­—ä½“ä¸€è‡´æ€§
- åˆ—è¡¨é¡¹ 3ï¼šåŒ…å« **ç²—ä½“** çš„åˆ—è¡¨é¡¹

ä¸‹é¢æ˜¯ä¸€ä¸ªè¡¨æ ¼æ ·å¼çš„å±•ç¤ºï¼š

| åºå· | é¡¹ç›®åç§° | çŠ¶æ€ | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- |
| 1 | ç³»ç»Ÿæ¶æ„è®¾è®¡ | å®Œæˆ | æ ¸å¿ƒæ¨¡å— |
| 2 | å‰ç«¯ç•Œé¢å¼€å‘ | è¿›è¡Œä¸­ | æ ·å¼è°ƒæ•´ |
| 3 | åç«¯æ¥å£è”è°ƒ | å¾…å¼€å§‹ | API å¯¹æ¥ |

# Sample Document (Level One Heading)

This is the main body of the document. It demonstrates **bold**, *italic*, and regular text with line spacing and font effects. By modifying the style configurations on the left, you can instantly preview changes to the body font, size, color, and line spacing.

## Level Two Heading Example
A level two heading is typically used for chapter divisions.

### Level Three Heading Example
A level three heading is used for more detailed content grouping.

## Lists and Tables Display

Below is an unordered list:
- List Item 1: Testing indentation and alignment
- List Item 2: Testing font consistency
- List Item 3: List item with **bold** text

Here is a demonstration of table styling:

| No. | Item Name | Status | Remarks |
| :--- | :--- | :--- | :--- |
| 1 | System Architecture Design | Completed | Core Module |
| 2 | Frontend UI Development | In Progress | Style Adjustment |
| 3 | Backend API Integration | To Be Started | API Docking |`;

    // --- Elements ---
    const els = {
      templateSelect: document.getElementById('templateSelect'),
      paper: document.getElementById('paper-container'),
      status: document.getElementById('statusText'),
      inputs: document.querySelectorAll('input, select'), // all inputs
      downloadBtn: document.getElementById('downloadBtn'),
      headerFileInput: document.getElementById('headerFileInput'),
      editMdBtn: document.getElementById('editMdBtn'),
      refDocInput: document.getElementById('refDocInput'),
      // New Elements
      previewContainer: document.getElementById('previewContainer'),
      editorContainer: document.getElementById('editorContainer'),
      inlineMdEditor: document.getElementById('inlineMdEditor'),
      saveInlineEdit: document.getElementById('saveInlineEdit'),
      cancelInlineEdit: document.getElementById('cancelInlineEdit'),
      // Professional Mode
      jsonConfigEditor: document.getElementById('jsonConfigEditor'),
      applyJsonBtn: document.getElementById('applyJsonBtn'),
      professionalModeDetails: document.getElementById('professionalModeDetails')
    };

    // --- Initialization ---
    async function init() {
      try {
        const templates = await API.getTemplates();
        els.templateSelect.innerHTML = '';
        templates.forEach(t => {
          templatesCache[t.id] = t.style || {};
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.id + (t.description ? ` - ${t.description}` : '');
          els.templateSelect.appendChild(opt);
        });
        
        // Trigger initial load
        if (templates.length > 0) {
            const initialId = templates[0].id;
            currentStyleConfig = JSON.parse(JSON.stringify(templatesCache[initialId])); // Deep copy
            applyValuesFromConfig(currentStyleConfig);
            triggerPreview();
        }
      } catch (e) {
        console.error(e);
        els.status.textContent = "Error loading templates";
      }
    }

    // --- Logic ---
    
    function buildConfigFromInputs() {
      const getVal = (id) => document.getElementById(id).value;
      const getNum = (id) => Number(document.getElementById(id).value) || undefined;
      const getCol = (id) => document.getElementById(id).value; // Hex
      
      // Helper: Convert UI PT to Backend Half-PT
      const getHalfPt = (id) => {
          const val = getNum(id);
          return val !== undefined ? val * 2 : undefined;
      };

      // Start with current config to preserve hidden fields (from JSON edits)
      const base = JSON.parse(JSON.stringify(currentStyleConfig || {}));

      const uiConfig = {
        fontHeader1: getVal('fontHeader1') || undefined,
        fontSizeH1: getHalfPt('fontSizeH1'),
        colorHeader1: inputToHex(getCol('colorHeader1')),
        titleAlignment: getVal('titleAlignment') || undefined,

        fontHeader2: getVal('fontHeader2') || undefined,
        fontSizeH2: getHalfPt('fontSizeH2'),
        colorHeader2: inputToHex(getCol('colorHeader2')),

        fontHeader3: getVal('fontHeader3') || undefined,
        fontSizeH3: getHalfPt('fontSizeH3'),
        colorHeader3: inputToHex(getCol('colorHeader3')),

        fontHeader4: getVal('fontHeader4') || undefined,
        fontSizeH4: getHalfPt('fontSizeH4'),
        colorHeader4: inputToHex(getCol('colorHeader4')),

        fontHeader5: getVal('fontHeader5') || undefined,
        fontSizeH5: getHalfPt('fontSizeH5'),
        colorHeader5: inputToHex(getCol('colorHeader5')),

        fontHeader6: getVal('fontHeader6') || undefined,
        fontSizeH6: getHalfPt('fontSizeH6'),
        colorHeader6: inputToHex(getCol('colorHeader6')),

        fontMain: getVal('fontMain') || undefined,
        fontSizeMain: getHalfPt('fontSizeMain'),
        lineSpacing: getNum('lineSpacing'),
        paragraphIndent: getNum('paragraphIndent'),
        
        margin: {
          ...(base.margin || {}), // preserve other margin props if any
          top: getVal('marginTop') || undefined,
          bottom: getVal('marginBottom') || undefined,
          left: getVal('marginLeft') || undefined,
          right: getVal('marginRight') || undefined,
        },
        
        table: {
            ...(base.table || {}), // preserve other table props
            borderStyle: getVal('tableBorderStyle') || undefined,
            borderSize: getNum('tableBorderSize'),
            borderColor: inputToHex(getCol('tableBorderColor')),
            headerBold: document.getElementById('tableHeaderBold').checked
        }
      };

      // Merge UI config into base
      // We do a shallow merge for top-level, and specific merges for nested objects
      const merged = { ...base, ...uiConfig };
      merged.margin = { ...base.margin, ...uiConfig.margin };
      merged.table = { ...base.table, ...uiConfig.table };

      return merged;
    }
    
    // --- Professional Mode Logic ---
    function updateJsonEditorFromState() {
        if(els.professionalModeDetails.open) {
            els.jsonConfigEditor.value = JSON.stringify(currentStyleConfig, null, 2);
        }
    }

    els.applyJsonBtn.addEventListener('click', () => {
        try {
            const newConfig = JSON.parse(els.jsonConfigEditor.value);
            // Update State
            currentStyleConfig = newConfig;
            // Update UI to match
            applyValuesFromConfig(currentStyleConfig);
            // Trigger Preview
            triggerPreview();
            alert("Configuration Applied!");
        } catch(e) {
            alert("Invalid JSON: " + e.message);
        }
    });

    els.professionalModeDetails.addEventListener('toggle', () => {
         if(els.professionalModeDetails.open) {
             updateJsonEditorFromState();
         }
    });

    function applyValuesFromConfig(style) {
      if(!style) return;
      const setVal = (id, v) => { 
        const el = document.getElementById(id); 
        if(el) el.value = (v === undefined ? '' : v); 
      };
      
      // Helper: Convert Backend Half-PT to UI PT
      const setPt = (id, halfPtVal, displayId) => {
          const ptVal = halfPtVal ? halfPtVal / 2 : undefined;
          setVal(id, ptVal);
          const displayEl = document.getElementById(displayId);
          if (displayEl) {
              displayEl.textContent = ptVal ? getChineseFontSize(ptVal) : '';
          }
      };
      
      setVal('fontHeader1', style.fontHeader1);
      setPt('fontSizeH1', style.fontSizeH1, 'chineseFontSizeH1');
      setVal('colorHeader1', hexToInput(style.colorHeader1));
      setVal('titleAlignment', style.titleAlignment);

      setVal('fontHeader2', style.fontHeader2);
      setPt('fontSizeH2', style.fontSizeH2, 'chineseFontSizeH2');
      setVal('colorHeader2', hexToInput(style.colorHeader2));

      setVal('fontHeader3', style.fontHeader3);
      setPt('fontSizeH3', style.fontSizeH3, 'chineseFontSizeH3');
      setVal('colorHeader3', hexToInput(style.colorHeader3));

      setVal('fontHeader4', style.fontHeader4);
      setPt('fontSizeH4', style.fontSizeH4, 'chineseFontSizeH4');
      setVal('colorHeader4', hexToInput(style.colorHeader4));

      setVal('fontHeader5', style.fontHeader5);
      setPt('fontSizeH5', style.fontSizeH5, 'chineseFontSizeH5');
      setVal('colorHeader5', hexToInput(style.colorHeader5));

      setVal('fontHeader6', style.fontHeader6);
      setPt('fontSizeH6', style.fontSizeH6, 'chineseFontSizeH6');
      setVal('colorHeader6', hexToInput(style.colorHeader6));

      setVal('fontMain', style.fontMain);
      setPt('fontSizeMain', style.fontSizeMain, 'chineseFontSizeMain');
      setVal('lineSpacing', style.lineSpacing);
      setVal('paragraphIndent', style.paragraphIndent);

      if(style.margin) {
        setVal('marginTop', style.margin.top);
        setVal('marginBottom', style.margin.bottom);
        setVal('marginLeft', style.margin.left);
        setVal('marginRight', style.margin.right);
      }

      if(style.table) {
          setVal('tableBorderStyle', style.table.borderStyle);
          setVal('tableBorderSize', style.table.borderSize);
          setVal('tableBorderColor', hexToInput(style.table.borderColor));
          document.getElementById('tableHeaderBold').checked = !!style.table.headerBold;
      }
    }

    // Helper for Color
    function hexToInput(hex) {
       if (!hex) return '#000000';
       return hex.startsWith('#') ? hex : '#' + hex;
    }
    function inputToHex(val) {
       return val ? val.replace('#', '').toUpperCase() : undefined;
    }

    // --- Preview Logic ---
    function triggerPreview() {
      els.status.textContent = "Updating Preview...";
      if (debounceTimer) clearTimeout(debounceTimer);
      
      debounceTimer = setTimeout(async () => {
        try {
          // Sync UI inputs to State
          currentStyleConfig = buildConfigFromInputs();
          // Sync State to JSON Editor (if open)
          updateJsonEditorFromState();

          const config = currentStyleConfig;
          // Pass current markdown content for live preview
          const blob = await API.preview(config, markdownContent);
          
          els.paper.innerHTML = '';
          await docx.renderAsync(blob, els.paper, null, {
            inWrapper: true,
            ignoreWidth: false,
            experimental: true,
            breakPages: true
          });
          
          els.status.textContent = "Preview Updated";
        } catch (err) {
          console.error(err);
          els.status.textContent = "Preview Failed";
        }
      }, 600); // 600ms debounce
    }

    // --- Event Listeners ---
    
    // 1. All inputs trigger preview (and update chinese font size display)
    document.querySelectorAll('input, select').forEach(el => {
      if(el.id === 'templateSelect' || el.id === 'refDocInput' || el.type === 'file') return;
      el.addEventListener('input', () => {
        // Update Chinese font size display for relevant inputs
        if (el.id.startsWith('fontSizeH') || el.id === 'fontSizeMain') {
            const chineseDisplayId = 'chinese' + el.id.charAt(0).toUpperCase() + el.id.slice(1);
            const chineseDisplayEl = document.getElementById(chineseDisplayId);
            if (chineseDisplayEl) {
                chineseDisplayEl.textContent = getChineseFontSize(el.value);
            }
        }
        triggerPreview();
      });
      el.addEventListener('change', triggerPreview);
    });

    // Initialize Chinese font size display for all font size inputs
    const fontSizeInputs = [
        'fontSizeH1', 'fontSizeH2', 'fontSizeH3', 'fontSizeH4', 'fontSizeH5', 'fontSizeH6', 'fontSizeMain'
    ];
    fontSizeInputs.forEach(id => {
        const input = document.getElementById(id);
        const chineseDisplayId = 'chinese' + id.charAt(0).toUpperCase() + id.slice(1);
        const chineseDisplayEl = document.getElementById(chineseDisplayId);
        if (input && chineseDisplayEl) {
            chineseDisplayEl.textContent = getChineseFontSize(input.value);
        }
    });

    // 2. Template Change
    els.templateSelect.addEventListener('change', (e) => {
        const tId = e.target.value;
        if(templatesCache[tId]) {
            currentStyleConfig = JSON.parse(JSON.stringify(templatesCache[tId])); // Deep copy
            applyValuesFromConfig(currentStyleConfig);
            triggerPreview();
        }
    });
    
    // 3. Reference Doc Import
    els.refDocInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        alert("Reference Doc styling will be applied during final conversion. Preview support for Reference Doc is pending backend API update.");
    });

    // 4. Tabs for Headings
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
             // UI toggle
             document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
             tab.classList.add('active');
             
             // Content toggle
             const target = tab.dataset.target; // h1, h2, h3
             document.querySelectorAll('.style-pane').forEach(p => p.style.display = 'none');
             document.getElementById(target + '-controls').style.display = 'block';
        });
    });

    // 5. Download
    els.downloadBtn.addEventListener('click', async () => {
        const config = buildConfigFromInputs();
        els.status.textContent = "Converting...";
        try {
            const blob = await API.convert({
                markdown: markdownContent,
                styleConfig: config,
                filename: 'document.docx'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.docx';
            document.body.appendChild(a);
            a.click();
            a.remove();
            els.status.textContent = "Download Started";
        } catch(e) {
            alert(e.message);
            els.status.textContent = "Download Error";
        }
    });

    // 6. Header File Import (.md / .docx)
    els.headerFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        els.status.textContent = "Loading File...";
        try {
            if (file.name.toLowerCase().endsWith('.docx')) {
                const data = await API.importDocx(file);
                markdownContent = data.markdown || '';
                els.status.textContent = "DOCX Imported";
            } else {
                // Text/Markdown
                markdownContent = await file.text();
                els.status.textContent = "Markdown Imported";
            }
            // Auto refresh preview with new content
            triggerPreview();
        } catch (err) {
            console.error(err);
            alert("Import failed: " + err.message);
            els.status.textContent = "Import Failed";
        }
        // Reset to allow re-selection
        els.headerFileInput.value = '';
    });

    // 7. Edit Markdown (Inline)
    els.editMdBtn.addEventListener('click', () => {
        // Switch to Editor Mode
        els.previewContainer.style.display = 'none';
        els.editorContainer.style.display = 'flex';
        
        // Load Content
        els.inlineMdEditor.value = markdownContent;
        els.inlineMdEditor.focus();
    });
    
    // Save Edit
    els.saveInlineEdit.addEventListener('click', () => {
        markdownContent = els.inlineMdEditor.value;
        
        // Switch back to Preview Mode
        els.editorContainer.style.display = 'none';
        els.previewContainer.style.display = 'flex';
        
        triggerPreview(); // Refresh
    });

    // Cancel Edit
    els.cancelInlineEdit.addEventListener('click', () => {
        // Simply switch back without saving
        els.editorContainer.style.display = 'none';
        els.previewContainer.style.display = 'flex';
    });

    // 8. Export PDF
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', async () => {
            if (API.isElectron()) {
                // Electron Native Print
                els.status.textContent = "Exporting PDF...";
                try {
                    const success = await window.electronAPI.printToPDF();
                    if(success) els.status.textContent = "PDF Exported";
                    else els.status.textContent = "PDF Cancelled";
                } catch (e) {
                    console.error(e);
                    alert("PDF Export Failed: " + e.message);
                    els.status.textContent = "Error";
                }
            } else {
                // Web: Browser Print
                window.print();
            }
        });
    }

    // 9. Export Image (Long Image)
    const exportImgBtn = document.getElementById('exportImgBtn');
    if (exportImgBtn) {
        exportImgBtn.addEventListener('click', async () => {
            els.status.textContent = "Generating Image...";
            try {
                // Target the wrapper created by docx-preview
                const element = document.querySelector('.docx-wrapper') || document.getElementById('paper-container');
                if(!element) throw new Error("Preview content not found");

                const canvas = await html2canvas(element, { 
                    scale: 2, // High resolution
                    backgroundColor: '#ffffff', // Ensure white background
                    useCORS: true 
                });
                
                // Download
                const link = document.createElement('a');
                link.download = `export_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                els.status.textContent = "Image Exported";
            } catch (e) {
                console.error(e);
                alert("Image Export Failed: " + e.message);
                els.status.textContent = "Error";
            }
        });
    }

    // Start
    init();

  </script>
</body>
</html>
